"use strict";(self.webpackChunkangor=self.webpackChunkangor||[]).push([[253],{7253:(G,L,c)=>{c.d(L,{m:()=>V});var u=c(467),v=c(4412),E=c(1413),R=c(1985),g=c(8810),K=c(6648),y=c(7673),x=c(6977),M=c(5964),U=c(8141),b=c(6697),S=c(5558),A=c(6354),C=c(9437),P=c(3294),T=c(274),w=c(7442),d=c(3953),I=c(1553),W=c(6324),$=c(4224),H=c(6231),k=c(345),F=c(9192);let V=(()=>{class o{constructor(e,t,s,a,i,r){this._metadataService=e,this._signerService=t,this._indexedDBService=s,this._relayService=a,this._sanitizer=i,this.router=r,this.chatList=[],this.latestMessageTimestamps={},this.messageQueue=[],this.isDecrypting=!1,this.decryptedPrivateKey="",this._chat=new v.t(null),this._chats=new v.t(null),this._contact=new v.t(null),this._contacts=new v.t(null),this._profile=new v.t(null),this._unsubscribeAll=new E.B}get profile$(){return this._profile.asObservable()}get chat$(){return this._chat.asObservable()}get chats$(){return this._chats.asObservable()}get contact$(){return this._contact.asObservable()}get contacts$(){return this._contacts.asObservable()}getContact(e){var t=this;return(0,u.A)(function*(){try{if(!e)return;const s=yield t._metadataService.fetchMetadataWithCache(e);s&&(t._contact.next({pubKey:e,displayName:s.name?s.name:"Unknown",picture:s.picture,about:s.about}),t._indexedDBService.getMetadataStream().pipe((0,x.Q)(t._unsubscribeAll)).subscribe(i=>{i&&i.pubkey===e&&t._contact.next({pubKey:e,displayName:i.metadata.name?i.metadata.name:"Unknown",picture:i.metadata.picture,about:i.metadata.about})}))}catch(s){console.error("Error fetching contact metadata:",s)}})()}getContacts(){return new R.c(e=>(this._indexedDBService.getAllUsers().then(t=>{if(t&&t.length>0){const s=t.map(a=>(a.pubKey||console.error("Contact is missing pubKey:",a),a.name=a.name?a.name:"Unknown",a));this._contacts.next(s),e.next(s)}else e.next([]);e.complete()}).catch(t=>{console.error("Error loading cached contacts from IndexedDB:",t),e.next([]),e.complete()}),{unsubscribe(){}}))}updateChatListMetadata(){var e=this;return(0,u.A)(function*(){const t=e.chatList.map(s=>s.contact?.pubKey).filter(s=>s);t.length>0&&((yield e._metadataService.fetchMetadataForMultipleKeys(t)).forEach(a=>{const i=e._contacts.value?.find(n=>n.pubKey===a.pubkey);i&&(i.displayName=a.metadata.name||"Unknown",i.picture=a.metadata.picture||i.picture,i.about=a.metadata.about||i.about);const r=e.chatList.find(n=>n.contact?.pubKey===a.pubkey);r&&(r.contact.displayName=a.metadata.name||"Unknown",r.contact.picture=a.metadata.picture||r.contact.picture,r.contact.about=a.metadata.about||r.contact.about)}),e._chats.next(e.chatList),e._contacts.next(e._contacts.value||[]))})()}subscribeToRealTimeMetadataUpdates(e){this._metadataService.getMetadataStream().pipe((0,M.p)(t=>t&&t.pubkey===e)).subscribe(t=>{const s=this.chatList.find(i=>i.contact?.pubKey===e);s&&(s.contact.displayName=t.metadata.name||"Unknown",s.contact.picture=t.metadata.picture||s.contact.picture,s.contact.about=t.metadata.about||s.contact.about,this._chats.next(this.chatList));const a=this._contacts.value?.find(i=>i.pubKey===e);a&&(a.displayName=t.metadata.name||"Unknown",a.picture=t.metadata.picture||a.picture,a.about=t.metadata.about||a.about,this._contacts.next(this._contacts.value||[]))})}getProfile(){var e=this;return(0,u.A)(function*(){try{const t=e._signerService.getPublicKey(),s=yield e._metadataService.fetchMetadataWithCache(t);s&&(e._profile.next(s),e._indexedDBService.getMetadataStream().pipe((0,x.Q)(e._unsubscribeAll)).subscribe(a=>{a&&a.pubkey===t&&e._profile.next(a.metadata)}))}catch(t){console.error("Error fetching profile metadata:",t)}})()}getChats(){var e=this;return(0,u.A)(function*(){return e.getChatListStream().pipe((0,U.M)(t=>{const s=t.filter(a=>a.contact?.pubKey).map(a=>a.contact.pubKey);e.subscribeToRealTimeMetadataUpdatesBatch(s)}))})()}InitSubscribeToChatList(){var e=this;return(0,u.A)(function*(){const t=e._signerService.getPublicKey(),s=yield e._signerService.isUsingExtension(),a=yield e._signerService.isUsingSecretKey();return e.decryptedPrivateKey=a?yield e._signerService.getDecryptedSecretKey():"",yield Promise.all([e.updateChatListMetadata(),e.subscribeToChatList(t,s,a,e.decryptedPrivateKey)]),e.getChatListStream()})()}subscribeToRealTimeMetadataUpdatesBatch(e){e.forEach(t=>{this.subscribeToRealTimeMetadataUpdates(t)})}subscribeToChatList(e,t,s,a){var i=this;return this._relayService.ensureConnectedRelays().then((0,u.A)(function*(){const r=[{kinds:[4],authors:[e]},{kinds:[4],"#p":[e]}];var n;i._relayService.getPool().subscribeMany(i._relayService.getConnectedRelays(),r,{onevent:(n=(0,u.A)(function*(l){const h=l.pubkey===e?l.tags.find(f=>"p"===f[0])?.[1]||"":l.pubkey;h&&l.created_at>(i.latestMessageTimestamps[h]||0)&&(i.messageQueue.push(l),i.processNextMessage(e,t,s,a))}),function(h){return n.apply(this,arguments)}),oneose:()=>{console.log("Subscription closed"),i._chats.next(i.chatList)}})})),this.getChatListStream()}processNextMessage(e,t,s,a){var i=this;return(0,u.A)(function*(){if(!i.isDecrypting&&0!==i.messageQueue.length){i.isDecrypting=!0;try{for(;i.messageQueue.length>0;){const r=i.messageQueue.shift();if(!r)continue;const n=r.pubkey===e,l=n?r.tags.find(p=>"p"===p[0])?.[1]||"":r.pubkey;if(!l)continue;const h=yield i.decryptReceivedMessage(r,t,s,a,l);h&&i.addOrUpdateChatList(l,h,r.created_at,n)}}catch(r){console.error(r)}finally{i.isDecrypting=!1}}})()}addOrUpdateChatList(e,t,s,a){const i=this.chatList.find(n=>n.contact?.pubKey===e),r={id:`${e}-${s}`,chatId:e,contactId:e,isMine:a,value:t,createdAt:new Date(1e3*s).toISOString()};if(i)i.messages?.some(l=>l.id===r.id)||(i.messages=[...i.messages||[],r].sort((l,h)=>new Date(l.createdAt).getTime()-new Date(h.createdAt).getTime()),Number(i.lastMessageAt)<s&&(i.lastMessage=t,i.lastMessageAt=s.toString()));else{const n=this._contacts.value?.find(h=>h.pubKey===e)||{pubKey:e},l={id:e,contact:{pubKey:n.pubKey,name:n.name||"Unknown",picture:n.picture||"/images/avatars/avatar-placeholder.png",about:n.about||"",displayName:n.displayName||n.name||"Unknown"},lastMessage:t,lastMessageAt:s.toString(),messages:[r]};this.chatList.push(l)}this.chatList.sort((n,l)=>Number(l.lastMessageAt)-Number(n.lastMessageAt)),this._chats.next(this.chatList)}getChatListStream(){return this._chats.asObservable()}decryptReceivedMessage(e,t,s,a,i){var r=this;return(0,u.A)(function*(){return t&&!s?yield r._signerService.decryptMessageWithExtension(i,e.content):s&&!t?yield r._signerService.decryptMessage(a,i,e.content):void 0})()}loadChatHistory(e){var t=this;return(0,u.A)(function*(){const s=t._signerService.getPublicKey(),a=[{kinds:[4],authors:[s],"#p":[e],limit:10},{kinds:[4],authors:[e],"#p":[s],limit:10}];var i;t._relayService.getPool().subscribeMany(t._relayService.getConnectedRelays(),a,{onevent:(i=(0,u.A)(function*(r){const n=r.pubkey===s,l=n?e:r.pubkey,h=yield t._signerService.isUsingExtension(),p=yield t._signerService.isUsingSecretKey(),f=yield t.decryptReceivedMessage(r,h,p,t.decryptedPrivateKey,l);if(f){const Q=Math.floor(r.created_at);t.addOrUpdateChatList(e,f,Q,n),t._chat.next(t.chatList.find(j=>j.id===e))}}),function(n){return i.apply(this,arguments)}),oneose:()=>{}})})()}updateChat(e,t){return this.chats$.pipe((0,b.s)(1),(0,S.n)(s=>{const a=t.contact?.pubKey;if(!a)return(0,g.$)("No public key found for this chat");const i={kind:4,pubkey:a,content:JSON.stringify(t),created_at:Math.floor(Date.now()/1e3),tags:[["p",a]]};return i.id=(0,w.dq)(i),(0,K.H)(this._relayService.publishEventToRelays(i)).pipe((0,A.T)(()=>{if(s){const r=s.findIndex(n=>n.id===e);-1!==r&&(s[r]=t,this._chats.next(s))}return t}),(0,C.W)(r=>(console.error("Failed to update chat via Nostr:",r),(0,g.$)(r))))}))}getChatById(e){this.recipientPublicKey=e;const t=this._signerService.getPublicKey();return(0,K.H)(Promise.all([t])).pipe((0,S.n)(()=>this.chats$.pipe((0,b.s)(1),(0,P.F)(),(0,M.p)(s=>!!s),(0,S.n)(s=>{const a=s?.find(n=>n.id===e);if(a&&a.messages.length>0)return this._chat.next(a),this.loadChatHistory(this.recipientPublicKey),(0,y.of)(a);const i={id:this.recipientPublicKey,contact:{pubKey:this.recipientPublicKey,picture:"/images/avatars/avatar-placeholder.png"},lastMessage:"",lastMessageAt:(new Date).toISOString(),messages:[]},r=s?[...s,i]:[i];return this._chats.next(r),this._chat.next(i),this.loadChatHistory(this.recipientPublicKey),(0,y.of)(i)}))),(0,C.W)(s=>(console.error("Error fetching chat by id from Nostr:",s),(0,g.$)(s))))}openChat(e){return e.pubKey?(this.recipientPublicKey=e.pubKey,this.chats$.pipe((0,b.s)(1),(0,P.F)(),(0,T.H)(t=>{const s=t?.find(r=>r.id===e.pubKey);if(s)return this._chat.next(s),this.loadChatHistory(e.pubKey),(0,y.of)(s);const a={id:e.pubKey,contact:{pubKey:e.pubKey,name:e.name,picture:e.picture||"/images/avatars/avatar-placeholder.png",about:e.about,displayName:e.displayName},lastMessage:"",lastMessageAt:(new Date).toISOString(),messages:[]},i=t?[...t,a]:[a];return this._chats.next(i),this._chat.next(a),this.loadChatHistory(e.pubKey),(0,y.of)(a)}),(0,C.W)(t=>{console.error("Error fetching chat by ID:",t);const s=this.router.url.split("/").slice(0,-1).join("/");return this.router.navigateByUrl(s),(0,g.$)(t)}))):(console.error("The contact does not have a public key!"),(0,g.$)("The contact does not have a public key!"))}resetChat(){this._chat.next(null)}sendPrivateMessage(e){var t=this;return(0,u.A)(function*(){try{t.message=e;const s=yield t._signerService.isUsingExtension(),a=yield t._signerService.isUsingSecretKey();if(s&&!a)yield t.handleMessageSendingWithExtension();else if(!s&&a){if(!t.isValidMessageSetup())return void console.error("Message, sender private key, or recipient public key is not properly set.");const i=yield t._signerService.encryptMessage(t.decryptedPrivateKey,t.recipientPublicKey,t.message),r=t._signerService.getUnsignedEvent(4,[["p",t.recipientPublicKey]],i),n=t._signerService.getSignedEvent(r,t.decryptedPrivateKey);(yield t._relayService.publishEventToRelays(n))?t.message="":console.error("Failed to send the message.")}}catch(s){console.error("Error sending private message:",s)}})()}handleMessageSendingWithExtension(){var e=this;return(0,u.A)(function*(){try{const t=yield e._signerService.encryptMessageWithExtension(e.message,e.recipientPublicKey),s=yield e._signerService.signEventWithExtension({kind:4,pubkey:e._signerService.getPublicKey(),tags:[["p",e.recipientPublicKey]],content:t,created_at:Math.floor(Date.now()/1e3)});(yield e._relayService.publishEventToRelays(s))?e.message="":console.error("Failed to send the message with extension.")}catch(t){console.error("Error sending message with extension:",t)}})()}isValidMessageSetup(){return""!==this.message.trim()&&""!==this.recipientPublicKey}ngOnDestroy(){this._unsubscribeAll.next(),this._unsubscribeAll.complete()}static#e=this.\u0275fac=function(t){return new(t||o)(d.KVO(I.T),d.KVO(W.A),d.KVO($.n),d.KVO(H.b),d.KVO(k.up),d.KVO(F.Ix))};static#t=this.\u0275prov=d.jDH({token:o,factory:o.\u0275fac,providedIn:"root"})}return o})()}}]);