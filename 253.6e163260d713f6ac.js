"use strict";(self.webpackChunkangor=self.webpackChunkangor||[]).push([[253],{7253:(Q,P,l)=>{l.d(P,{m:()=>_});var h=l(467),L=l(7442),y=l(4412),T=l(1413),w=l(1985),C=l(8810),f=l(6648),N=l(7673),O=l(6977),D=l(5964),k=l(8141),x=l(6697),b=l(5558),M=l(6354),K=l(9437),d=l(4438),W=l(2827),B=l(4930),I=l(7291),H=l(6231),$=l(2083);let _=(()=>{class o{constructor(e,t,s,r,a){this._metadataService=e,this._signerService=t,this._storageService=s,this._relayService=r,this.stateService=a,this.chatList=[],this.latestMessageTimestamps={},this.messageQueue=[],this.isDecrypting=!1,this.decryptedPrivateKey="",this._chat=new y.t(null),this._chats=new y.t(null),this._contact=new y.t(null),this._contacts=new y.t(null),this._profile=new y.t(null),this._unsubscribeAll=new T.B}get profile$(){return this._profile.asObservable()}get chat$(){return this._chat.asObservable()}get chats$(){return this._chats.asObservable()}get contact$(){return this._contact.asObservable()}get contacts$(){return this._contacts.asObservable()}checkCurrentChatOnPageRefresh(e){e&&this.getChatById(e).subscribe(s=>{s&&(this._chat.next(s),this.loadChatHistory(e))})}getContact(e){var t=this;return(0,h.A)(function*(){try{if(!e)return;const s=yield t._metadataService.fetchMetadataWithCache(e);s&&(t._contact.next({pubKey:e,displayName:s.name?s.name:"Unknown",picture:s.picture,about:s.about}),t._storageService.getMetadataStream().pipe((0,O.Q)(t._unsubscribeAll)).subscribe(a=>{a&&a.pubkey===e&&t._contact.next({pubKey:e,displayName:a.metadata.name?a.metadata.name:"Unknown",picture:a.metadata.picture,about:a.metadata.about})}))}catch(s){console.error("Error fetching contact metadata:",s)}})()}getContacts(){return new w.c(e=>(this._storageService.getAllUsers().then(t=>{if(t&&t.length>0){const s=t.map(r=>(r.pubKey||console.error("Contact is missing pubKey:",r),r));this._contacts.next(s),e.next(s)}else e.next([]);e.complete()}).catch(t=>{console.error("Error loading cached contacts from IndexedDB:",t),e.next([]),e.complete()}),{unsubscribe(){}}))}updateChatListMetadata(){var e=this;return(0,h.A)(function*(){const t=e.chatList.map(s=>s.contact?.pubKey).filter(s=>s);t.length>0&&((yield e._metadataService.fetchMetadataForMultipleKeys(t)).forEach(r=>{const a=e._contacts.value?.find(n=>n.pubKey===r.pubkey);a&&(a.displayName=r.metadata.name||"Unknown",a.picture=r.metadata.picture||a.picture,a.about=r.metadata.about||a.about);const i=e.chatList.find(n=>n.contact?.pubKey===r.pubkey);i&&(i.contact.displayName=r.metadata.name||"Unknown",i.contact.picture=r.metadata.picture||i.contact.picture,i.contact.about=r.metadata.about||i.contact.about)}),e._chats.next(e.chatList),e._contacts.next(e._contacts.value||[]))})()}subscribeToRealTimeMetadataUpdates(e){this._metadataService.getMetadataStream().pipe((0,D.p)(t=>t&&t.pubkey===e)).subscribe(t=>{const s=this.chatList.find(a=>a.contact?.pubKey===e);s&&(s.contact.displayName=t.metadata.name||"Unknown",s.contact.picture=t.metadata.picture||s.contact.picture,s.contact.about=t.metadata.about||s.contact.about,this._chats.next(this.chatList));const r=this._contacts.value?.find(a=>a.pubKey===e);r&&(r.displayName=t.metadata.name||"Unknown",r.picture=t.metadata.picture||r.picture,r.about=t.metadata.about||r.about,this._contacts.next(this._contacts.value||[]))})}getProfile(){var e=this;return(0,h.A)(function*(){try{e.stateService.profileMetadata$.subscribe(t=>{e._profile.next(t)})}catch(t){console.error("Error fetching profile metadata:",t)}})()}getChats(){var e=this;return(0,h.A)(function*(){return e.getChatListStream().pipe((0,k.M)(t=>{if(t&&0===t.length)return;const s=t.filter(r=>r.contact?.pubKey).map(r=>r.contact.pubKey);e.subscribeToRealTimeMetadataUpdatesBatch(s)}))})()}InitSubscribeToChatList(){var e=this;return(0,h.A)(function*(){const t=e._signerService.getPublicKey(),s=yield e._signerService.isUsingExtension(),r=yield e._signerService.isUsingSecretKey();return e.decryptedPrivateKey=r?yield e._signerService.getDecryptedSecretKey():"",yield Promise.all([e.updateChatListMetadata(),e.subscribeToChatList(t,s,r,e.decryptedPrivateKey)]),e.getChatListStream()})()}subscribeToRealTimeMetadataUpdatesBatch(e){e.forEach(t=>{this.subscribeToRealTimeMetadataUpdates(t)})}subscribeToChatList(e,t,s,r){var a=this;return this._relayService.ensureConnectedRelays().then((0,h.A)(function*(){const i=[{kinds:[4],authors:[e],limit:1500},{kinds:[4],"#p":[e],limit:1500}];var n;a._relayService.getPool().subscribeMany(a._relayService.getConnectedRelays(),i,{onevent:(n=(0,h.A)(function*(c){const u=c.pubkey===e?c.tags.find(p=>"p"===p[0])?.[1]||"":c.pubkey;u&&c.created_at>(a.latestMessageTimestamps[u]||0)&&(a.messageQueue.push(c),a.processNextMessage(e,t,s,r))}),function(u){return n.apply(this,arguments)}),oneose:()=>{(a.chatList||[]).length>0&&a._chats.next(a.chatList)}})})),this.getChatListStream()}processNextMessage(e,t,s,r){var a=this;return(0,h.A)(function*(){if(!a.isDecrypting&&0!==a.messageQueue.length){a.isDecrypting=!0;try{for(;a.messageQueue.length>0;){const i=a.messageQueue.shift();if(!i)continue;const n=i.pubkey===e,c=n?i.tags.find(v=>"p"===v[0])?.[1]||"":i.pubkey;if(!c)continue;const u=yield a.decryptReceivedMessage(i,t,s,r,c);u&&a.addOrUpdateChatList(c,u,i.created_at,n)}}catch(i){console.error(i)}finally{a.isDecrypting=!1}}})()}addOrUpdateChatList(e,t,s,r){const a=this.chatList.find(n=>n.contact?.pubKey===e),i={id:`${e}-${s}`,chatId:e,contactId:e,isMine:r,value:t,createdAt:new Date(1e3*s).toISOString()};if(a)a.messages?.some(c=>c.id===i.id)||(a.messages=[...a.messages||[],i].sort((c,u)=>new Date(c.createdAt).getTime()-new Date(u.createdAt).getTime()),Number(a.lastMessageAt)<s&&(a.lastMessage=t,a.lastMessageAt=s.toString()));else{const n=this._contacts.value?.find(u=>u.pubKey===e)||{pubKey:e},c={id:e,contact:{pubKey:n.pubKey,name:n.name||"Unknown",picture:n.picture||"/images/avatars/avatar-placeholder.png",about:n.about||"",displayName:n.displayName||n.name||"Unknown"},lastMessage:t,lastMessageAt:s.toString(),messages:[i]};this.chatList.push(c)}this.chatList.sort((n,c)=>Number(c.lastMessageAt)-Number(n.lastMessageAt)),this._chats.next(this.chatList)}getChatListStream(){return this._chats.asObservable()}decryptReceivedMessage(e,t,s,r,a){var i=this;return(0,h.A)(function*(){return t&&!s?yield i._signerService.decryptMessageWithExtension(a,e.content):s&&!t?yield i._signerService.decryptMessage(r,a,e.content):void 0})()}loadChatHistory(e){var t=this;return(0,h.A)(function*(){const s=t._signerService.getPublicKey(),r=[{kinds:[4],authors:[s],"#p":[e],limit:10},{kinds:[4],authors:[e],"#p":[s],limit:10}];var a;t._relayService.getPool().subscribeMany(t._relayService.getConnectedRelays(),r,{onevent:(a=(0,h.A)(function*(i){const n=i.pubkey===s,c=n?e:i.pubkey,u=yield t._signerService.isUsingExtension(),v=yield t._signerService.isUsingSecretKey(),p=yield t.decryptReceivedMessage(i,u,v,t.decryptedPrivateKey,c);if(p){const m=Math.floor(i.created_at);t.addOrUpdateChatList(e,p,m,n),t._chat.next(t.chatList.find(S=>S.id===e))}}),function(n){return a.apply(this,arguments)}),oneose:()=>{}})})()}fetchChatHistory(e){var t=this;return(0,h.A)(function*(){const s=t._signerService.getPublicKey(),r=[{kinds:[4],authors:[s],"#p":[e],limit:10},{kinds:[4],authors:[e],"#p":[s],limit:10}],a=[];return t._relayService.getPool().subscribeMany(t._relayService.getConnectedRelays(),r,{onevent:(i=(0,h.A)(function*(n){const c=n.pubkey===s,u=c?e:n.pubkey,v=yield t._signerService.isUsingExtension(),p=yield t._signerService.isUsingSecretKey(),m=yield t.decryptReceivedMessage(n,v,p,t.decryptedPrivateKey,u);if(m){const S=Math.floor(n.created_at),F={id:n.id,chatId:e,contactId:u,isMine:c,value:m,createdAt:new Date(1e3*S).toISOString()};a.push(F),t.addOrUpdateChatList(e,m,S,c),t._chat.next(t.chatList.find(V=>V.id===e))}}),function(c){return i.apply(this,arguments)}),oneose:()=>{}}),yield new Promise(i=>setTimeout(i,1e3)),a;var i})()}updateChat(e,t){return this.chats$.pipe((0,x.s)(1),(0,b.n)(s=>{const r=t.contact?.pubKey;if(!r)return(0,C.$)("No public key found for this chat");const a={kind:4,pubkey:r,content:JSON.stringify(t),created_at:Math.floor(Date.now()/1e3),tags:[["p",r]]};return a.id=(0,L.dq)(a),(0,f.H)(this._relayService.publishEventToWriteRelays(a)).pipe((0,M.T)(()=>{if(s){const i=s.findIndex(n=>n.id===e);-1!==i&&(s[i]=t,this._chats.next(s))}return t}),(0,K.W)(i=>(console.error("Failed to update chat via Nostr:",i),(0,C.$)(i))))}))}getChatById(e,t=null){return this.recipientPublicKey=e,(0,f.H)(Promise.all([this._signerService.getPublicKey()])).pipe((0,b.n)(()=>this.chats$.pipe((0,x.s)(1),(0,b.n)(s=>{if(!s||0===s.length)return this.createNewChat(e,t);const r=s.find(a=>a.id===e);return r?(this._chat.next(r),this.loadChatHistory(this.recipientPublicKey),(0,N.of)(r)):this.createNewChat(e,t)}))),(0,K.W)(s=>(console.error("Error fetching chat by id from Nostr:",s),(0,C.$)(s))))}createNewChat(e,t=null){const s={id:e||"",contact:t?{pubKey:t.pubKey||e,name:t.name||"Unknown",picture:t.picture||"/images/avatars/avatar-placeholder.png"}:{pubKey:e,name:"Unknown",picture:"/images/avatars/avatar-placeholder.png"},lastMessage:"new chat...",lastMessageAt:Math.floor(Date.now()/1e3).toString()||"0",messages:[]};return(0,f.H)(this._metadataService.fetchMetadataWithCache(e)).pipe((0,M.T)(r=>(s.contact={pubKey:e,name:r?.name||"Unknown",picture:r?.picture||"/images/avatars/avatar-placeholder.png",about:r?.about||"",displayName:r?.displayName||r?.name||"Unknown"},s)),(0,b.n)(r=>(0,f.H)(this.fetchChatHistory(e)).pipe((0,M.T)(a=>{if(0===a.length){const n={id:`${e}-new-chat`,chatId:e,contactId:e,isMine:!0,value:"new chat...",createdAt:Math.floor(Date.now()/1e3).toString()};a.push(n)}if(s.messages=a,a.length>0){const n=a[a.length-1];s.lastMessage=n.value,s.lastMessageAt=n.createdAt}const i=this._chats.value?[...this._chats.value,s]:[s];return this._chats.next(i),this._chat.next(s),s}))))}resetChat(){this._chat.next(null)}sendPrivateMessage(e){var t=this;return(0,h.A)(function*(){try{t.message=e;const s=yield t._signerService.isUsingExtension(),r=yield t._signerService.isUsingSecretKey();if(s&&!r)yield t.handleMessageSendingWithExtension();else if(!s&&r){if(!t.isValidMessageSetup())return void console.error("Message, sender private key, or recipient public key is not properly set.");const a=yield t._signerService.encryptMessage(t.decryptedPrivateKey,t.recipientPublicKey,t.message),i=t._signerService.getUnsignedEvent(4,[["p",t.recipientPublicKey]],a),n=t._signerService.getSignedEvent(i,t.decryptedPrivateKey);(yield t._relayService.publishEventToWriteRelays(n))?t.message="":console.error("Failed to send the message.")}}catch(s){console.error("Error sending private message:",s)}})()}handleMessageSendingWithExtension(){var e=this;return(0,h.A)(function*(){try{const t=yield e._signerService.encryptMessageWithExtension(e.message,e.recipientPublicKey),s=yield e._signerService.signEventWithExtension({kind:4,pubkey:e._signerService.getPublicKey(),tags:[["p",e.recipientPublicKey]],content:t,created_at:Math.floor(Date.now()/1e3)});(yield e._relayService.publishEventToWriteRelays(s))?e.message="":console.error("Failed to send the message with extension.")}catch(t){console.error("Error sending message with extension:",t)}})()}isValidMessageSetup(){return""!==this.message.trim()&&""!==this.recipientPublicKey}ngOnDestroy(){this._unsubscribeAll.next(),this._unsubscribeAll.complete()}static#e=this.\u0275fac=function(t){return new(t||o)(d.KVO(W.T),d.KVO(B.A),d.KVO(I.n),d.KVO(H.b),d.KVO($.d))};static#t=this.\u0275prov=d.jDH({token:o,factory:o.\u0275fac,providedIn:"root"})}return o})()}}]);