"use strict";(self.webpackChunkangor=self.webpackChunkangor||[]).push([[879],{1879:(k,C,o)=>{o.d(C,{m:()=>B});var h=o(467),K=o(7442),_=o(8418),p=o(4412),O=o(1413),x=o(1985),b=o(8810),f=o(6648),D=o(7673),A=o(5964),L=o(8141),P=o(6697),m=o(5558),E=o(6354),S=o(9437),g=o(4438),T=o(2827),U=o(4930),R=o(7291),I=o(6231),W=o(2083);let B=(()=>{class y{constructor(e,t,s,i,n){this._metadataService=e,this._signerService=t,this._storageService=s,this._relayService=i,this.stateService=n,this.chatList=[],this.latestMessageTimestamps={},this.messageQueue=[],this.isDecrypting=!1,this.decryptedPrivateKey="",this._chat=new p.t(null),this._chats=new p.t(null),this._contact=new p.t(null),this._contacts=new p.t(null),this._profile=new p.t(null),this._unsubscribeAll=new O.B}get profile$(){return this._profile.asObservable()}get chat$(){return this._chat.asObservable()}get chats$(){return this._chats.asObservable()}get contact$(){return this._contact.asObservable()}get contacts$(){return this._contacts.asObservable()}checkCurrentChatOnPageRefresh(e){e&&this.getChatById(e).subscribe(s=>{s&&(this._chat.next(s),this.loadChatHistory(e))})}getContact(e){var t=this;return(0,h.A)(function*(){try{if(!e)return;const s=yield t._metadataService.fetchMetadataWithCache(e);s&&t._contact.next({pubKey:e,displayName:s.name?s.name:"Unknown",picture:s.picture,about:s.about})}catch(s){console.error("Error fetching contact metadata:",s)}})()}getContacts(){return new x.c(e=>(this._storageService.getAllProfiles().then(t=>{if(t&&t.length>0){const s=t.map(i=>(i.pubKey||console.error("Contact is missing pubKey:",i),i));this._contacts.next(s),e.next(s)}else e.next([]);e.complete()}).catch(t=>{console.error("Error loading cached contacts from IndexedDB:",t),e.next([]),e.complete()}),{unsubscribe(){}}))}updateChatListMetadata(){var e=this;return(0,h.A)(function*(){const t=e.chatList.map(s=>s.contact?.pubKey).filter(s=>s);t.length>0&&((yield e._metadataService.fetchMetadataForMultipleKeys(t)).forEach(i=>{const n=e._contacts.value?.find(a=>a.pubKey===i.pubkey);n&&(n.displayName=i.metadata.name||"Unknown",n.picture=i.metadata.picture||n.picture,n.about=i.metadata.about||n.about);const r=e.chatList.find(a=>a.contact?.pubKey===i.pubkey);r&&(r.contact.displayName=i.metadata.name||"Unknown",r.contact.picture=i.metadata.picture||r.contact.picture,r.contact.about=i.metadata.about||r.contact.about)}),e._chats.next(e.chatList),e._contacts.next(e._contacts.value||[]))})()}subscribeToRealTimeMetadataUpdates(e){this._metadataService.getMetadataStream().pipe((0,A.p)(t=>t&&t.pubkey===e)).subscribe(t=>{const s=this.chatList.find(n=>n.contact?.pubKey===e);s&&(s.contact.displayName=t.metadata.name||"Unknown",s.contact.picture=t.metadata.picture||s.contact.picture,s.contact.about=t.metadata.about||s.contact.about,this._chats.next(this.chatList));const i=this._contacts.value?.find(n=>n.pubKey===e);i&&(i.displayName=t.metadata.name||"Unknown",i.picture=t.metadata.picture||i.picture,i.about=t.metadata.about||i.about,this._contacts.next(this._contacts.value||[]))})}getProfile(){var e=this;return(0,h.A)(function*(){try{e._storageService.profile$.subscribe(t=>{t&&t.pubKey&&t.metadata&&t.pubKey===e._signerService.getPublicKey()&&e._profile.next(t.metadata)}),e._storageService.getProfile(e._signerService.getPublicKey()).then(t=>{e._profile.next(t)})}catch(t){console.error("Error fetching profile metadata:",t)}})()}getChats(){var e=this;return(0,h.A)(function*(){return e.getChatListStream().pipe((0,L.M)(t=>{if(t&&0===t.length)return;const s=t.filter(i=>i.contact?.pubKey).map(i=>i.contact.pubKey);e.subscribeToRealTimeMetadataUpdatesBatch(s)}))})()}InitSubscribeToChatList(){var e=this;return(0,h.A)(function*(){const t=e._signerService.getPublicKey(),s=yield e._signerService.isUsingExtension(),i=yield e._signerService.isUsingSecretKey();return e.decryptedPrivateKey=i?yield e._signerService.getDecryptedSecretKey():"",yield Promise.all([e.updateChatListMetadata(),e.subscribeToChatList(t,s,i,e.decryptedPrivateKey)]),e.getChatListStream()})()}subscribeToRealTimeMetadataUpdatesBatch(e){e.forEach(t=>{this.subscribeToRealTimeMetadataUpdates(t)})}subscribeToChatList(e,t,s,i){var n=this;return this._relayService.ensureConnectedRelays().then((0,h.A)(function*(){const r=[{kinds:[_.rV],authors:[e],limit:1500},{kinds:[_.rV],"#p":[e],limit:1500}];var a;n._relayService.getPool().subscribeMany(n._relayService.getConnectedRelays(),r,{onevent:(a=(0,h.A)(function*(c){const l=c.pubkey===e?c.tags.find(d=>"p"===d[0])?.[1]||"":c.pubkey;l&&c.created_at>(n.latestMessageTimestamps[l]||0)&&(n.messageQueue.push(c),n.processNextMessage(e,t,s,i))}),function(l){return a.apply(this,arguments)}),oneose:()=>{(n.chatList||[]).length>0&&n._chats.next(n.chatList)}})})),this.getChatListStream()}processNextMessage(e,t,s,i){var n=this;return(0,h.A)(function*(){if(!n.isDecrypting&&0!==n.messageQueue.length){n.isDecrypting=!0;try{for(;n.messageQueue.length>0;){const r=n.messageQueue.shift();if(!r)continue;const a=r.pubkey===e,c=a?r.tags.find(u=>"p"===u[0])?.[1]||"":r.pubkey;if(!c)continue;const l=yield n.decryptReceivedMessage(r,t,s,i,c);l&&n.addOrUpdateChatList(c,l,r.created_at,a)}}catch(r){console.error(r)}finally{n.isDecrypting=!1}}})()}addOrUpdateChatList(e,t,s,i){const n=this.chatList.find(a=>a.contact?.pubKey===e),r={id:`${e}-${s}`,chatId:e,contactId:e,isMine:i,value:t,createdAt:new Date(1e3*s).toISOString()};if(n)n.messages?.some(c=>c.id===r.id)||(n.messages=[...n.messages||[],r].sort((c,l)=>new Date(c.createdAt).getTime()-new Date(l.createdAt).getTime()),Number(n.lastMessageAt)<s&&(n.lastMessage=t,n.lastMessageAt=s.toString()));else{const a=this._contacts.value?.find(l=>l.pubKey===e)||{pubKey:e},c={id:e,contact:{pubKey:a.pubKey,name:a.name||"Unknown",picture:a.picture||"/images/avatars/avatar-placeholder.png",about:a.about||"",displayName:a.displayName||a.name||"Unknown"},lastMessage:t,lastMessageAt:s.toString(),messages:[r]};this.chatList.push(c)}this.chatList.sort((a,c)=>Number(c.lastMessageAt)-Number(a.lastMessageAt)),this._chats.next(this.chatList)}getChatListStream(){return this._chats.asObservable()}decryptReceivedMessage(e,t,s,i,n){var r=this;return(0,h.A)(function*(){return t&&!s?yield r._signerService.decryptMessageWithExtension(n,e.content):s&&!t?yield r._signerService.decryptMessage(i,n,e.content):void 0})()}loadChatHistory(e){var t=this;return(0,h.A)(function*(){const s=t._signerService.getPublicKey(),i=[{kinds:[_.rV],authors:[s],"#p":[e],limit:10},{kinds:[_.rV],authors:[e],"#p":[s],limit:10}];var n;t._relayService.getPool().subscribeMany(t._relayService.getConnectedRelays(),i,{onevent:(n=(0,h.A)(function*(r){const a=r.pubkey===s,c=a?e:r.pubkey,l=yield t._signerService.isUsingExtension(),u=yield t._signerService.isUsingSecretKey(),d=yield t.decryptReceivedMessage(r,l,u,t.decryptedPrivateKey,c);if(d){const v=Math.floor(r.created_at);t.addOrUpdateChatList(e,d,v,a),t._chat.next(t.chatList.find(M=>M.id===e))}}),function(a){return n.apply(this,arguments)}),oneose:()=>{}})})()}fetchChatHistory(e){var t=this;return(0,h.A)(function*(){const s=t._signerService.getPublicKey(),i=[{kinds:[_.rV],authors:[s],"#p":[e],limit:10},{kinds:[_.rV],authors:[e],"#p":[s],limit:10}],n=[];return t._relayService.getPool().subscribeMany(t._relayService.getConnectedRelays(),i,{onevent:(r=(0,h.A)(function*(a){const c=a.pubkey===s,l=c?e:a.pubkey,u=yield t._signerService.isUsingExtension(),d=yield t._signerService.isUsingSecretKey(),v=yield t.decryptReceivedMessage(a,u,d,t.decryptedPrivateKey,l);if(v){const M=Math.floor(a.created_at),w={id:a.id,chatId:e,contactId:l,isMine:c,value:v,createdAt:new Date(1e3*M).toISOString()};n.push(w),t.addOrUpdateChatList(e,v,M,c),t._chat.next(t.chatList.find(N=>N.id===e))}}),function(c){return r.apply(this,arguments)}),oneose:()=>{}}),yield new Promise(r=>setTimeout(r,1e3)),n;var r})()}updateChat(e,t){return this.chats$.pipe((0,P.s)(1),(0,m.n)(s=>{const i=t.contact?.pubKey;if(!i)return(0,b.$)("No public key found for this chat");const n={kind:4,pubkey:i,content:JSON.stringify(t),created_at:Math.floor(Date.now()/1e3),tags:[["p",i]]};return n.id=(0,K.dq)(n),(0,f.H)(this._relayService.publishEventToWriteRelays(n)).pipe((0,E.T)(()=>{if(s){const r=s.findIndex(a=>a.id===e);-1!==r&&(s[r]=t,this._chats.next(s))}return t}),(0,S.W)(r=>(console.error("Failed to update chat via Nostr:",r),(0,b.$)(r))))}))}getChatById(e,t=null){return this.recipientPublicKey=e,(0,f.H)(Promise.all([this._signerService.getPublicKey()])).pipe((0,m.n)(()=>this.chats$.pipe((0,P.s)(1),(0,m.n)(s=>{if(!s||0===s.length)return this.createNewChat(e,t);const i=s.find(n=>n.id===e);return i?(this._chat.next(i),this.loadChatHistory(this.recipientPublicKey),(0,D.of)(i)):this.createNewChat(e,t)}))),(0,S.W)(s=>(console.error("Error fetching chat by id from Nostr:",s),(0,b.$)(s))))}createNewChat(e,t=null){const s={id:e||"",contact:t?{pubKey:t.pubKey||e,name:t.name||"Unknown",picture:t.picture||"/images/avatars/avatar-placeholder.png"}:{pubKey:e,name:"Unknown",picture:"/images/avatars/avatar-placeholder.png"},lastMessage:"new chat...",lastMessageAt:Math.floor(Date.now()/1e3).toString()||"0",messages:[]};return(0,f.H)(this._metadataService.fetchMetadataWithCache(e)).pipe((0,E.T)(i=>(s.contact={pubKey:e,name:i?.name||"Unknown",picture:i?.picture||"/images/avatars/avatar-placeholder.png",about:i?.about||"",displayName:i?.displayName||i?.name||"Unknown"},s)),(0,m.n)(i=>(0,f.H)(this.fetchChatHistory(e)).pipe((0,E.T)(n=>{if(0===n.length){const a={id:`${e}-new-chat`,chatId:e,contactId:e,isMine:!0,value:"new chat...",createdAt:Math.floor(Date.now()/1e3).toString()};n.push(a)}if(s.messages=n,n.length>0){const a=n[n.length-1];s.lastMessage=a.value,s.lastMessageAt=a.createdAt}const r=this._chats.value?[...this._chats.value,s]:[s];return this._chats.next(r),this._chat.next(s),s}))))}resetChat(){this._chat.next(null)}sendPrivateMessage(e){var t=this;return(0,h.A)(function*(){try{t.message=e;const s=yield t._signerService.isUsingExtension(),i=yield t._signerService.isUsingSecretKey();if(s&&!i)yield t.handleMessageSendingWithExtension();else if(!s&&i){if(!t.isValidMessageSetup())return void console.error("Message, sender private key, or recipient public key is not properly set.");const n=yield t._signerService.encryptMessage(t.decryptedPrivateKey,t.recipientPublicKey,t.message),r=t._signerService.getUnsignedEvent(4,[["p",t.recipientPublicKey]],n),a=t._signerService.getSignedEvent(r,t.decryptedPrivateKey);(yield t._relayService.publishEventToWriteRelays(a))?t.message="":console.error("Failed to send the message.")}}catch(s){console.error("Error sending private message:",s)}})()}handleMessageSendingWithExtension(){var e=this;return(0,h.A)(function*(){try{const t=yield e._signerService.encryptMessageWithExtension(e.message,e.recipientPublicKey),s=yield e._signerService.signEventWithExtension({kind:4,pubkey:e._signerService.getPublicKey(),tags:[["p",e.recipientPublicKey]],content:t,created_at:Math.floor(Date.now()/1e3)});(yield e._relayService.publishEventToWriteRelays(s))?e.message="":console.error("Failed to send the message with extension.")}catch(t){console.error("Error sending message with extension:",t)}})()}isValidMessageSetup(){return""!==this.message.trim()&&""!==this.recipientPublicKey}ngOnDestroy(){this._unsubscribeAll.next(),this._unsubscribeAll.complete()}static#e=this.\u0275fac=function(t){return new(t||y)(g.KVO(T.T),g.KVO(U.A),g.KVO(R.n),g.KVO(I.b),g.KVO(W.d))};static#t=this.\u0275prov=g.jDH({token:y,factory:y.\u0275fac,providedIn:"root"})}return y})()}}]);