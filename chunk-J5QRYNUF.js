import{b as me}from"./chunk-HP2KUAWQ.js";import{a as xe}from"./chunk-4A5M7RW6.js";import{b as pe}from"./chunk-QMYO46ZN.js";import{c as ge,d as je,e as ve,f as ye}from"./chunk-MC32A4E6.js";import{t as _,v as ue}from"./chunk-L5JOHRO3.js";import"./chunk-EPSS3MK7.js";import{V as he,W as fe,t as ie,y as oe,z as se}from"./chunk-IXH6PIJ2.js";import"./chunk-6PAL4IQQ.js";import{$ as ce,V as re,X as ne,Z as ae,ba as le,ca as de}from"./chunk-WKHOS5S7.js";import{Aa as M,Ab as u,Ba as p,Ca as j,Cb as x,D,Ib as q,Jb as W,Kb as H,Pa as I,Q as k,Ua as f,W as P,Xb as Q,Z as b,a as T,b as U,ba as K,db as n,eb as l,ec as G,fb as v,fc as Y,gb as B,gc as J,h as d,hb as N,ia as S,ja as w,jb as L,k as $,ka as z,l as A,la as R,lc as X,mb as C,ob as E,pc as Z,q as F,sb as O,uc as ee,yc as te,zb as V}from"./chunk-IRG7MLS7.js";var be=(()=>{let i=class i{constructor(e,t,r){this.http=e,this.indexerService=t,this.indexedDBService=r,this.offset=0,this.limit=20,this.totalProjects=0,this.loading=!1,this.projects=[],this.noMoreProjects=!1,this.totalProjectsFetched=!1,this.selectedNetwork="testnet",this.loadNetwork()}loadNetwork(){this.selectedNetwork=this.indexerService.getNetwork()}fetchProjects(){return d(this,null,function*(){if(this.loading||this.noMoreProjects)return[];this.loading=!0;let e=this.indexerService.getPrimaryIndexer(this.selectedNetwork),t=this.totalProjectsFetched?`${e}api/query/Angor/projects?offset=${this.offset}&limit=${this.limit}`:`${e}api/query/Angor/projects?limit=${this.limit}`;try{let r=yield this.http.get(t,{observe:"response"}).toPromise();if(!this.totalProjectsFetched&&r&&r.headers){let h=r.headers.get("pagination-total");this.totalProjects=h?+h:0,this.totalProjectsFetched=!0,this.offset=Math.max(this.totalProjects-this.limit,0)}let a=r?.body||[];if(!a.length)return this.noMoreProjects=!0,[];let o=a.filter(h=>!this.projects.some(y=>y.projectIdentifier===h.projectIdentifier));if(!o.length)return this.noMoreProjects=!0,[];let c=o.map(h=>d(this,null,function*(){yield this.indexedDBService.saveProject(h)})),g=o.map(h=>d(this,null,function*(){try{let y=yield this.indexedDBService.getProjectStats(h.projectIdentifier);return h.totalInvestmentsCount=y?.investorCount??0,h}catch(y){return console.error(`Error fetching details for project ${h.projectIdentifier}:`,y),h}}));return yield Promise.all([...c,...g]),this.projects=[...this.projects,...o],this.offset=Math.max(this.offset-this.limit,0),o}catch(r){return console.error("Error fetching projects:",r),[]}finally{this.loading=!1}})}fetchProjectStats(e){let r=`${this.indexerService.getPrimaryIndexer(this.selectedNetwork)}api/query/Angor/projects/${e}/stats`;return this.http.get(r).pipe(D(a=>(console.error(`Error fetching stats for project ${e}:`,a),F({}))))}fetchAndSaveProjectStats(e){return d(this,null,function*(){try{let t=yield this.fetchProjectStats(e).toPromise();return t&&(yield this.indexedDBService.saveProjectStats(e,t)),t}catch(t){return console.error(`Error fetching and saving stats for project ${e}:`,t),null}})}fetchProjectDetails(e){let r=`${this.indexerService.getPrimaryIndexer(this.selectedNetwork)}api/query/Angor/projects/${e}`;return this.http.get(r).pipe(D(a=>(console.error(`Error fetching details for project ${e}:`,a),F({}))))}fetchAndSaveProjectDetails(e){return d(this,null,function*(){try{let t=yield this.fetchProjectDetails(e).toPromise();return t&&(yield this.indexedDBService.saveProject(t)),t}catch(t){return console.error(`Error fetching and saving details for project ${e}:`,t),null}})}getAllProjectsFromDB(){return d(this,null,function*(){return this.indexedDBService.getAllProjects()})}getProjectStatsFromDB(e){return d(this,null,function*(){return this.indexedDBService.getProjectStats(e)})}getProjects(){return this.projects}resetProjects(){this.projects=[],this.noMoreProjects=!1,this.offset=0,this.totalProjectsFetched=!1}};i.\u0275fac=function(t){return new(t||i)(b(Z),b(ye),b(_))},i.\u0275prov=P({token:i,factory:i.\u0275fac,providedIn:"root"});let s=i;return s})();var Se=(()=>{let i=class i{constructor(){this.projects=[],this.projectsSubject=new A([])}getProjectsObservable(){return this.projectsSubject.asObservable()}setProjects(e){this.projects=e,this.projectsSubject.next(this.projects)}getProjects(){return this.projects}hasProjects(){return this.projects.length>0}updateProject(e){let t=this.projects.findIndex(r=>r.nostrPubKey===e.nostrPubKey);t>-1?this.projects[t]=e:this.projects.push(e),this.projectsSubject.next(this.projects)}getProjectByPubKey(e){return this.projects.find(t=>t.nostrPubKey===e)}};i.\u0275fac=function(t){return new(t||i)},i.\u0275prov=P({token:i,factory:i.\u0275fac,providedIn:"root"});let s=i;return s})();var Ee=()=>[],_e=s=>({"-ml-3":s});function Fe(s,i){if(s&1&&(B(0),v(1,"img",41),N()),s&2){let m=i.index,e=E().$implicit;p(),O("alt","Investor avatar ",m+1,""),f("ngClass",H(4,_e,e.totalInvestmentsCount>1&&m>0))("src","images/avatars/avatar-placeholder.png",M)}}function De(s,i){if(s&1&&(B(0),n(1,"angor-card",24)(2,"div",25),v(3,"img",26),l(),n(4,"div",27)(5,"div",28),v(6,"img",29),l()(),n(7,"div",30)(8,"div",31)(9,"div",32)(10,"div",33),u(11),l(),n(12,"div",34),u(13),l()(),n(14,"div",35)(15,"button",36),v(16,"mat-icon",37),l()()(),v(17,"hr",38),n(18,"div",31)(19,"div",39),u(20),l(),n(21,"div",40),I(22,Fe,2,6,"ng-container",20),l()()()(),N()),s&2){let m=i.$implicit,e=E();p(3),f("src",e.getSafeUrl(m==null?null:m.banner,!0)||"images/pages/profile/cover.jpg",M),p(3),f("src",e.getSafeUrl(m==null?null:m.picture,!1)||"images/avatars/avatar-placeholder.png",M),p(5),x(" ",m.displayName||m.nostrPubKey," "),p(2),x(" ",m.about||"No description available"," "),p(3),f("svgIcon","heroicons_solid:user-plus"),p(4),x(" ",m.totalInvestmentsCount||0," investors "),p(2),f("ngForOf",W(7,Ee).constructor(m.totalInvestmentsCount||0))}}function ke(s,i){if(s&1&&(n(0,"div",42),u(1),l()),s&2){let m=E();p(),x(" ",m.errorMessage," ")}}var we=(()=>{let i=class i{constructor(e,t,r,a,o,c,g){this.projectService=e,this.router=t,this.stateService=r,this.metadataService=a,this.indexedDBService=o,this.changeDetectorRef=c,this.sanitizer=g,this.projects=[],this.errorMessage="",this.loading=!1,this.metadataLoadLimit=5,this._unsubscribeAll=new $,this.filteredProjects=[]}ngOnInit(){return d(this,null,function*(){this.loadInitialProjects(),this.subscribeToMetadataUpdates()})}loadInitialProjects(){return d(this,null,function*(){try{if(this.loading=!0,this.projects=this.stateService.getProjects(),this.projects.length===0)yield this.loadProjectsFromService();else{this.filteredProjects=[...this.projects];let e=this.getProjectsWithoutMetadata();e.length>0&&(yield this.loadMetadataForProjects(e))}}catch{this.handleError("Error loading initial projects")}finally{this.loading=!1,this.changeDetectorRef.detectChanges()}})}loadProjectsFromService(){return d(this,null,function*(){try{let e=yield this.projectService.fetchProjects();if(e.length===0){this.errorMessage="No projects found";return}this.projects=e,this.filteredProjects=[...this.projects],this.stateService.setProjects(this.projects);let t=e.map(r=>r.nostrPubKey);yield this.loadMetadataForProjects(t)}catch{this.handleError("Error fetching projects from service")}})}subscribeToMetadataUpdates(){this.indexedDBService.getMetadataStream().pipe(k(this._unsubscribeAll)).subscribe(e=>{if(e){let t=this.projects.find(r=>r.nostrPubKey===e.pubkey);t&&this.updateProjectMetadata(t,e.metadata)}})}getProjectsWithoutMetadata(){return this.projects.filter(e=>!e.displayName||!e.about).map(e=>e.nostrPubKey)}loadMetadataForProjects(e){return d(this,null,function*(){let t=e.map(o=>d(this,null,function*(){let c=yield this.indexedDBService.getUserMetadata(o);return c?{pubkey:o,metadata:c}:null})),r=yield Promise.all(t),a=r.filter(o=>o===null).map((o,c)=>e[c]);r.forEach(o=>{if(o&&o.metadata){let c=this.projects.find(g=>g.nostrPubKey===o.pubkey);c&&this.updateProjectMetadata(c,o.metadata)}}),a.length>0&&(yield this.metadataService.fetchMetadataForMultipleKeys(a).then(o=>{o.forEach(c=>{let g=this.projects.find(h=>h.nostrPubKey===c.pubkey);g&&this.updateProjectMetadata(g,c)}),this.changeDetectorRef.detectChanges()}).catch(o=>{console.error("Error fetching metadata for projects:",o)}))})}loadProjects(){return d(this,null,function*(){this.loading||this.errorMessage==="No more projects found"||(this.loading=!0,this.projectService.fetchProjects().then(e=>d(this,null,function*(){if(e.length===0&&this.projects.length===0)this.errorMessage="No projects found";else if(e.length===0)this.errorMessage="No more projects found";else{this.projects=[...this.projects,...e],this.filteredProjects=[...this.projects];let t=e.map(r=>r.nostrPubKey);yield this.loadMetadataForProjects(t),this.stateService.setProjects(this.projects),this.projects.forEach(r=>this.subscribeToProjectMetadata(r))}this.loading=!1,this.changeDetectorRef.detectChanges()})).catch(e=>{console.error("Error fetching projects:",e),this.errorMessage="Error fetching projects. Please try again later.",this.loading=!1,this.changeDetectorRef.detectChanges()}))})}loadMetadataForProject(e){return d(this,null,function*(){try{let t=yield this.metadataService.fetchMetadataWithCache(e.nostrPubKey);t?this.updateProjectMetadata(e,t):console.warn(`No metadata found for project ${e.nostrPubKey}`)}catch(t){console.error(`Error fetching metadata for project ${e.nostrPubKey}:`,t)}})}updateProjectMetadata(e,t){let r=U(T({},e),{displayName:t.name||"",about:t.about?t.about.replace(/<\/?[^>]+(>|$)/g,""):"",picture:t.picture||"",banner:t.banner||""}),a=this.projects.findIndex(o=>o.projectIdentifier===e.projectIdentifier);a!==-1&&(this.projects[a]=r,this.projects=[...this.projects]),this.filteredProjects=[...this.projects],this.changeDetectorRef.detectChanges()}subscribeToProjectMetadata(e){this.metadataService.getMetadataStream().pipe(k(this._unsubscribeAll)).subscribe(t=>{t&&t.pubkey===e.nostrPubKey&&this.updateProjectMetadata(e,t.metadata)})}goToProjectDetails(e){this.router.navigate(["/projects",e.projectIdentifier])}filterByQuery(e){if(!e){this.filteredProjects=[...this.projects];return}this.filteredProjects=this.projects.filter(t=>t.displayName?.toLowerCase().includes(e.toLowerCase())||t.about?.toLowerCase().includes(e.toLowerCase()))}toggleCompleted(e){}ngOnDestroy(){this._unsubscribeAll.next(null),this._unsubscribeAll.complete()}handleError(e){console.error(e),this.errorMessage=e,this.loading=!1,this.changeDetectorRef.detectChanges()}getSafeUrl(e,t){if(e&&typeof e=="string"&&this.isImageUrl(e))return this.sanitizer.bypassSecurityTrustUrl(e);{let r=t?"/images/pages/profile/cover.jpg":"images/avatars/avatar-placeholder.png";return this.sanitizer.bypassSecurityTrustUrl(r)}}isImageUrl(e){return/\.(jpeg|jpg|gif|png|svg|bmp|webp|tiff|ico)$/i.test(e)}};i.\u0275fac=function(t){return new(t||i)(j(be),j(te),j(Se),j(ue),j(_),j(Q),j(ee))},i.\u0275cmp=K({type:i,selectors:[["explore"]],standalone:!0,features:[q],decls:29,vars:7,consts:[["query",""],[1,"absolute","inset-0","flex","min-w-0","flex-col","overflow-y-auto"],[1,"dark","relative","flex-0","overflow-hidden","bg-gray-800","px-4","py-8","sm:p-16"],["viewBox","0 0 960 540","width","100%","height","100%","preserveAspectRatio","xMidYMax slice","xmlns","http://www.w3.org/2000/svg",1,"absolute","inset-0","pointer-events-none"],["fill","none","stroke","currentColor","stroke-width","100",1,"text-gray-700","opacity-25"],["r","234","cx","196","cy","23"],["r","234","cx","790","cy","491"],[1,"relative","z-10","flex","flex-col","items-center"],[1,"text-xl","font-semibold"],[1,"mt-1","text-center","text-4xl","font-extrabold","leading-tight","tracking-tight","sm:text-7xl"],[1,"text-secondary","mt-6","max-w-2xl","text-center","tracking-tight","sm:text-2xl"],[1,"p-6","sm:p-10"],[1,"mx-auto","flex","w-full","max-w-xs","flex-auto","flex-col","sm:max-w-5xl"],[1,"flex","w-full","max-w-xs","flex-col","items-center","justify-between","sm:max-w-none","sm:flex-row"],[1,"mt-4","w-full","sm:mt-0","sm:w-72",3,"subscriptSizing"],["matPrefix","",1,"icon-size-5",3,"svgIcon"],["placeholder","Search ...","matInput","",3,"input"],[1,"mt-8","sm:ml-auto","sm:mt-0",3,"change","color"],[1,"mx-auto","flex","w-full","flex-auto","flex-col","sm:max-w-5xl"],[1,"grid","w-full","min-w-0","grid-cols-1","gap-6","sm:grid-cols-1","md:grid-cols-1","lg:grid-cols-2","mt-10"],[4,"ngFor","ngForOf"],[1,"flex","justify-center","mt-10"],["mat-raised-button","","color","primary",3,"click","disabled"],["class","error-message",4,"ngIf"],[1,"filter-info","flex","w-full","flex-col"],[1,"flex","h-32"],["onerror","this.onerror=null; this.src='/images/pages/profile/cover.jpg';","alt","Card cover image",1,"object-cover",3,"src"],[1,"flex","px-8"],[1,"bg-card","-mt-12","rounded-full","p-1"],["onerror","this.onerror=null; this.src='/images/avatars/avatar-placeholder.png';","alt","Project logo",1,"h-24","w-24","rounded-full","object-cover",3,"src"],[1,"flex","flex-col","px-8","pb-6","pt-4"],[1,"flex","items-center","justify-between"],[1,"mr-4","flex-1","min-w-0"],[1,"text-2xl","font-semibold","leading-tight","truncate"],[1,"text-secondary","mt-1","leading-tight","truncate"],[1,"flex","h-10","w-10","items-center","justify-center","rounded-full","border"],["mat-icon-button",""],[1,"icon-size-5",3,"svgIcon"],[1,"my-6","w-full","border-t"],[1,"text-secondary","mr-3","text-md","font-medium"],[1,"flex","items-center"],[1,"text-card","ring-bg-card","m-0.5","h-6","w-6","rounded-full","ring-2",3,"ngClass","src","alt"],[1,"error-message"]],template:function(t,r){if(t&1){let a=L();n(0,"div",1)(1,"div",2),z(),n(2,"svg",3)(3,"g",4),v(4,"circle",5)(5,"circle",6),l()(),R(),n(6,"div",7)(7,"h2",8),u(8,"Explore Projects"),l(),n(9,"div",9),u(10," What\u2019s your next investment? "),l(),n(11,"div",10),u(12," Check out our projects and find your next investment opportunity. "),l()()(),n(13,"div",11)(14,"div",12)(15,"div",13)(16,"mat-form-field",14),v(17,"mat-icon",15),n(18,"input",16,0),C("input",function(){S(a);let c=V(19);return w(r.filterByQuery(c.value))}),l()(),n(20,"mat-slide-toggle",17),C("change",function(c){return S(a),w(r.toggleCompleted(c))}),u(21," Hide completed "),l()()(),n(22,"div",18)(23,"div",19),I(24,De,23,8,"ng-container",20),l(),n(25,"div",21)(26,"button",22),C("click",function(){return S(a),w(r.loadProjects())}),u(27),l()(),I(28,ke,2,1,"div",23),l()()()}t&2&&(p(16),f("subscriptSizing","dynamic"),p(),f("svgIcon","heroicons_solid:magnifying-glass"),p(3),f("color","primary"),p(4),f("ngForOf",r.projects),p(2),f("disabled",r.loading),p(),x(" ",r.loading?"Loading...":"Load More Projects"," "),p(),f("ngIf",!r.loading&&r.errorMessage))},dependencies:[ce,ne,ae,de,le,xe,se,oe,ie,ge,re,fe,he,ve,je,G,pe,me,X,Y,J],encapsulation:2});let s=i;return s})();var vt=[{path:"",component:we}];export{vt as default};
