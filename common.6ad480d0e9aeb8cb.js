"use strict";(self.webpackChunkangor=self.webpackChunkangor||[]).push([[76],{7112:(I,g,s)=>{s.d(g,{U:()=>i});var u=s(3014),y=s(1217),h=s(3107),b=s(8078);let i=(()=>{class o{constructor(e){this._signerService=e,this.STORAGE_KEY="userBookmarkedProjects",this.bookmarksSubject=new y.t([]),this.bookmarks$=this.bookmarksSubject.asObservable(),this.currentUserPubKey=null,window.addEventListener("storage",t=>{t.key===this.STORAGE_KEY&&this.refreshBookmarksForCurrentUser()})}initializeForCurrentUser(){var e=this;return(0,u.A)(function*(){e.clearBookmarks(),e.currentUserPubKey=yield e._signerService.getPublicKey(),e.currentUserPubKey&&(yield e.loadBookmarksForCurrentUser())})()}clearBookmarks(){this.bookmarksSubject.next([])}loadBookmarksForCurrentUser(){var e=this;return(0,u.A)(function*(){if(!e.currentUserPubKey)return;const l=e.getUserBookmarks()[e.currentUserPubKey]||[];e.bookmarksSubject.next(l)})()}getUserBookmarks(){const e=localStorage.getItem(this.STORAGE_KEY);return e?JSON.parse(e):{}}saveUserBookmarks(e){localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e))}addBookmark(e){var t=this;return(0,u.A)(function*(){if(!t.currentUserPubKey&&(t.currentUserPubKey=yield t._signerService.getPublicKey(),!t.currentUserPubKey))return void console.warn("No public key found for the current user.");const l=t.getUserBookmarks(),m=l[t.currentUserPubKey]||[];m.includes(e)||(m.push(e),l[t.currentUserPubKey]=m,t.saveUserBookmarks(l),t.bookmarksSubject.next(m))})()}removeBookmark(e){var t=this;return(0,u.A)(function*(){if(!t.currentUserPubKey&&(t.currentUserPubKey=yield t._signerService.getPublicKey(),!t.currentUserPubKey))return void console.warn("No public key found for the current user.");const l=t.getUserBookmarks(),S=(l[t.currentUserPubKey]||[]).filter(v=>v!==e);l[t.currentUserPubKey]=S,t.saveUserBookmarks(l),t.bookmarksSubject.next(S)})()}isBookmarked(e){var t=this;return(0,u.A)(function*(){return t.currentUserPubKey||(t.currentUserPubKey=yield t._signerService.getPublicKey(),t.currentUserPubKey)?(t.getUserBookmarks()[t.currentUserPubKey]||[]).includes(e):(console.warn("No public key found for the current user."),!1)})()}getBookmarks(){var e=this;return(0,u.A)(function*(){return e.currentUserPubKey||(e.currentUserPubKey=yield e._signerService.getPublicKey(),e.currentUserPubKey)?e.getUserBookmarks()[e.currentUserPubKey]||[]:(console.warn("No public key found for the current user."),[])})()}removeAllBookmarks(){var e=this;return(0,u.A)(function*(){if(!e.currentUserPubKey&&(e.currentUserPubKey=yield e._signerService.getPublicKey(),!e.currentUserPubKey))return void console.warn("No public key found for the current user.");const t=e.getUserBookmarks();t[e.currentUserPubKey]=[],e.saveUserBookmarks(t),e.bookmarksSubject.next([])})()}refreshBookmarksForCurrentUser(){this.currentUserPubKey&&this.loadBookmarksForCurrentUser()}static{this.\u0275fac=function(t){return new(t||o)(h.KVO(b.A))}}static{this.\u0275prov=h.jDH({token:o,factory:o.\u0275fac,providedIn:"root"})}}return o})()},1128:(I,g,s)=>{s.d(g,{F:()=>y});var u=s(3107);let y=(()=>{class h{constructor(){this.mainnetLocalStorageKey="mainnetIndexers",this.testnetLocalStorageKey="testnetIndexers",this.mainnetPrimaryIndexerKey="mainnetPrimaryIndexer",this.testnetPrimaryIndexerKey="testnetPrimaryIndexer",this.networkStorageKey="selectedNetwork",this.defaultMainnetIndexer="https://btc.indexer.angor.io/",this.defaultTestnetIndexer="https://tbtc.indexer.angor.io/",this.initializeDefaultIndexers()}initializeDefaultIndexers(){0===this.getIndexers("mainnet").length&&(this.addIndexer(this.defaultMainnetIndexer,"mainnet"),this.setPrimaryIndexer(this.defaultMainnetIndexer,"mainnet")),0===this.getIndexers("testnet").length&&(this.addIndexer(this.defaultTestnetIndexer,"testnet"),this.setPrimaryIndexer(this.defaultTestnetIndexer,"testnet"))}addIndexer(i,o){let a=this.getIndexers(o);a.includes(i)||(a.push(i),this.saveIndexers(a,o))}getIndexers(i){return JSON.parse(localStorage.getItem("mainnet"===i?this.mainnetLocalStorageKey:this.testnetLocalStorageKey)||"[]")}saveIndexers(i,o){localStorage.setItem("mainnet"===o?this.mainnetLocalStorageKey:this.testnetLocalStorageKey,JSON.stringify(i))}setPrimaryIndexer(i,o){this.getIndexers(o).includes(i)&&localStorage.setItem("mainnet"===o?this.mainnetPrimaryIndexerKey:this.testnetPrimaryIndexerKey,i)}getPrimaryIndexer(i){return localStorage.getItem("mainnet"===i?this.mainnetPrimaryIndexerKey:this.testnetPrimaryIndexerKey)}removeIndexer(i,o){let a=this.getIndexers(o);const e=a.indexOf(i);-1!==e&&(a.splice(e,1),this.saveIndexers(a,o),i===this.getPrimaryIndexer(o))&&localStorage.removeItem("mainnet"===o?this.mainnetPrimaryIndexerKey:this.testnetPrimaryIndexerKey)}clearAllIndexers(i){const a="mainnet"===i?this.mainnetPrimaryIndexerKey:this.testnetPrimaryIndexerKey;localStorage.removeItem("mainnet"===i?this.mainnetLocalStorageKey:this.testnetLocalStorageKey),localStorage.removeItem(a)}setNetwork(i){localStorage.setItem(this.networkStorageKey,i)}getNetwork(){return localStorage.getItem(this.networkStorageKey)||"testnet"}static{this.\u0275fac=function(o){return new(o||h)}}static{this.\u0275prov=u.jDH({token:h,factory:h.\u0275fac,providedIn:"root"})}}return h})()},9528:(I,g,s)=>{s.d(g,{i:()=>O});var u=s(1217),y=s(3016),h=s(1787),b=s(8915),i=s(8249),o=s(5903),a=s(2040),e=s(7947),t=s(5823),l=s(2867),m=s(7178),S=s(1483),v=s(36),p=s(5351);const x=(d,k)=>(d.push(k),d);function j(){return(0,p.N)((d,k)=>{(function K(d,k){return(0,p.N)((0,v.S)(d,k,arguments.length>=2,!1,!0))})(x,[])(d).subscribe(k)})}var P=s(3107),U=s(7691),B=s(1128),E=s(3149),M=s(5506);let O=(()=>{class d{constructor(r,n,c,f){this.http=r,this.indexerService=n,this.storageService=c,this.subscriptionService=f,this.INITIAL_OFFSET=0,this.LIMIT=50,this.offset=this.INITIAL_OFFSET,this.totalProjects=0,this.totalProjectsFetched=!1,this.projectsSubject=new u.t([]),this.projects$=this.projectsSubject.asObservable().pipe((0,i.t)(1)),this.loadingSubject=new u.t(!1),this.loading$=this.loadingSubject.asObservable(),this.noMoreProjectsSubject=new u.t(!1),this.noMoreProjects$=this.noMoreProjectsSubject.asObservable(),this.projectStatsSubject=new u.t({}),this.projectStats$=this.projectStatsSubject.asObservable().pipe((0,i.t)(1)),this.selectedNetwork=this.indexerService.getNetwork(),console.log("Selected network:",this.selectedNetwork)}fetchProjects(){if(this.loadingSubject.value||this.noMoreProjectsSubject.value)return console.log("Skipping fetch: Already loading or no more projects."),(0,y.of)([]);this.loadingSubject.next(!0);const n=`${this.indexerService.getPrimaryIndexer(this.selectedNetwork)}api/query/Angor/projects?${this.totalProjectsFetched?`offset=${this.offset}&`:""}limit=${this.LIMIT}`;return this.http.get(n,{observe:"response"}).pipe((0,o.L)(3),(0,a.M)(c=>this.handlePaginationResponse(c)),(0,e.T)(c=>c.body||[]),(0,t.Z)(this.filterUniqueProjects.bind(this)),(0,l.n)(this.processNewProjects.bind(this)),(0,m.W)(this.handleError.bind(this)),(0,a.M)(()=>this.loadingSubject.next(!1)))}handlePaginationResponse(r){if(!this.totalProjectsFetched&&r?.headers){const n=r.headers.get("pagination-total");this.totalProjects=n?+n:0,this.totalProjectsFetched=!0,this.offset=Math.max(this.totalProjects-this.LIMIT,0)}}filterUniqueProjects(r){return(0,h.H)(r).pipe((0,S.p)(n=>!this.projectsSubject.value.some(c=>c.projectIdentifier===n.projectIdentifier)),j())}processNewProjects(r){if(!r.length)return this.noMoreProjectsSubject.next(!0),(0,y.of)([]);const n=(0,h.H)(r).pipe((0,t.Z)(f=>(0,h.H)(this.storageService.saveProject(f))),j()),c=(0,h.H)(r).pipe((0,t.Z)(this.fetchProjectDetails.bind(this)),j());return n.pipe((0,l.n)(()=>c),(0,a.M)(this.updateProjectsList.bind(this)))}fetchProjectDetails(r){return(0,h.H)(this.storageService.getProjectStats(r.projectIdentifier)).pipe((0,e.T)(n=>(r.totalInvestmentsCount=n?.investorCount??0,this.updateProjectStats(r.projectIdentifier,n),r)),(0,m.W)(n=>(console.error(`Error fetching details for project ${r.projectIdentifier}:`,n),(0,y.of)(r))))}updateProjectsList(r){const n=[...this.projectsSubject.value,...r];this.projectsSubject.next(n),this.subscribeToProjectsMetadata(r.map(c=>c.nostrPubKey)),this.offset=Math.max(this.offset-this.LIMIT,0)}updateProjectStats(r,n){this.projectStatsSubject.next({...this.projectStatsSubject.value,[r]:n})}handleError(r){return console.error("Error fetching projects:",r),this.loadingSubject.next(!1),(0,b.$)(()=>new Error("Failed to fetch projects. Please try again later."))}subscribeToProjectsMetadata(r){this.subscriptionService.addSubscriptions([{kinds:[0],authors:r}],c=>{const f=this.parseMetadataEvent(c);this.storageService.saveProfile(c.pubkey,f)})}parseMetadataEvent(r){try{return JSON.parse(r.content)}catch(n){return console.error("Error parsing metadata event:",n),{}}}fetchProjectStats(r){const c=`${this.indexerService.getPrimaryIndexer(this.selectedNetwork)}api/query/Angor/projects/${r}/stats`;return this.http.get(c).pipe((0,a.M)(f=>this.updateProjectStats(r,f)),(0,m.W)(f=>(console.error(`Error fetching stats for project ${r}:`,f),(0,y.of)({}))))}resetProjects(){this.projectsSubject.next([]),this.noMoreProjectsSubject.next(!1),this.loadingSubject.next(!1),this.projectStatsSubject.next({}),this.offset=this.INITIAL_OFFSET,this.totalProjectsFetched=!1}static{this.\u0275fac=function(n){return new(n||d)(P.KVO(U.Qq),P.KVO(B.F),P.KVO(E.n),P.KVO(M.n))}}static{this.\u0275prov=P.jDH({token:d,factory:d.\u0275fac,providedIn:"root"})}}return d})()}}]);