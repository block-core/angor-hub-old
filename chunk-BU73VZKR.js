import{b as Te}from"./chunk-4EFEYHIQ.js";import{a as Ue}from"./chunk-GCV77N7Y.js";import{b as Le,c as ke,d as Ke,e as _}from"./chunk-ZMHEHUPV.js";import"./chunk-G64UOYBP.js";import{a as C,b as k,c as Fe,i as G,j as De}from"./chunk-ESELKVAP.js";import{d as ve}from"./chunk-TYJTVVSW.js";import{c as Ne,d as _e,e as Be}from"./chunk-TW7SPV6B.js";import"./chunk-QWV7QHAT.js";import{T as Ae,U as Re,s as we,x as Se,y as Ee}from"./chunk-HPJTP5HY.js";import{$ as je,V as be,X as Pe,Z as Me,ba as Ie,ca as Ce}from"./chunk-TCT6OACC.js";import{A as ie,Aa as ae,Ba as ce,Bb as de,Cc as ye,Eb as N,Gb as fe,Hc as xe,K as ne,L as Q,Ob as ue,Pa as D,Pb as x,Ra as m,Rb as I,Sa as R,Wb as pe,h as f,ha as E,ib as q,kb as y,ma as b,n as T,o as se,qa as oe,t as A,vb as p,wb as g,wc as ge,xb as P,xc as me,ya as F,yb as le,za as K,zb as he}from"./chunk-PLEXPVNT.js";var $e=(()=>{let n=class n{constructor(){this.mainnetLocalStorageKey="mainnetIndexers",this.testnetLocalStorageKey="testnetIndexers",this.mainnetPrimaryIndexerKey="mainnetPrimaryIndexer",this.testnetPrimaryIndexerKey="testnetPrimaryIndexer",this.networkStorageKey="selectedNetwork",this.defaultMainnetIndexer="https://btc.indexer.angor.io/",this.defaultTestnetIndexer="https://tbtc.indexer.angor.io/",this.initializeDefaultIndexers()}initializeDefaultIndexers(){this.getIndexers("mainnet").length===0&&(this.addIndexer(this.defaultMainnetIndexer,"mainnet"),this.setPrimaryIndexer(this.defaultMainnetIndexer,"mainnet")),this.getIndexers("testnet").length===0&&(this.addIndexer(this.defaultTestnetIndexer,"testnet"),this.setPrimaryIndexer(this.defaultTestnetIndexer,"testnet"))}addIndexer(e,t){let r=this.getIndexers(t);r.includes(e)||(r.push(e),this.saveIndexers(r,t))}getIndexers(e){let t=e==="mainnet"?this.mainnetLocalStorageKey:this.testnetLocalStorageKey;return JSON.parse(localStorage.getItem(t)||"[]")}saveIndexers(e,t){let r=t==="mainnet"?this.mainnetLocalStorageKey:this.testnetLocalStorageKey;localStorage.setItem(r,JSON.stringify(e))}setPrimaryIndexer(e,t){if(this.getIndexers(t).includes(e)){let r=t==="mainnet"?this.mainnetPrimaryIndexerKey:this.testnetPrimaryIndexerKey;localStorage.setItem(r,e)}}getPrimaryIndexer(e){let t=e==="mainnet"?this.mainnetPrimaryIndexerKey:this.testnetPrimaryIndexerKey;return localStorage.getItem(t)}removeIndexer(e,t){let r=this.getIndexers(t),i=r.indexOf(e);if(i!==-1&&(r.splice(i,1),this.saveIndexers(r,t),e===this.getPrimaryIndexer(t))){let o=t==="mainnet"?this.mainnetPrimaryIndexerKey:this.testnetPrimaryIndexerKey;localStorage.removeItem(o)}}clearAllIndexers(e){let t=e==="mainnet"?this.mainnetLocalStorageKey:this.testnetLocalStorageKey,r=e==="mainnet"?this.mainnetPrimaryIndexerKey:this.testnetPrimaryIndexerKey;localStorage.removeItem(t),localStorage.removeItem(r)}setNetwork(e){localStorage.setItem(this.networkStorageKey,e)}getNetwork(){return localStorage.getItem(this.networkStorageKey)||"testnet"}};n.\u0275fac=function(t){return new(t||n)},n.\u0275prov=E({token:n,factory:n.\u0275fac,providedIn:"root"});let s=n;return s})();var Oe=(()=>{let n=class n{constructor(e,t){this.http=e,this.indexerService=t,this.offset=0,this.limit=9,this.totalProjects=0,this.loading=!1,this.projects=[],this.noMoreProjects=!1,this.totalProjectsFetched=!1,this.selectedNetwork="testnet",this.loadNetwork()}loadNetwork(){this.selectedNetwork=this.indexerService.getNetwork()}fetchProjects(){return f(this,null,function*(){if(this.loading||this.noMoreProjects)return[];this.loading=!0;let e=this.indexerService.getPrimaryIndexer(this.selectedNetwork),t=this.totalProjectsFetched?`${e}api/query/Angor/projects?offset=${this.offset}&limit=${this.limit}`:`${e}api/query/Angor/projects?limit=${this.limit}`;console.log(`Fetching projects from URL: ${t}`);try{let r=yield this.http.get(t,{observe:"response"}).toPromise();if(!this.totalProjectsFetched&&r&&r.headers){let o=r.headers.get("pagination-total");this.totalProjects=o?+o:0,console.log(`Total projects: ${this.totalProjects}`),this.totalProjectsFetched=!0,this.offset=Math.max(this.totalProjects-this.limit,0)}let i=r?.body||[];if(console.log("New projects received:",i),!i||i.length===0)return this.noMoreProjects=!0,[];{let o=i.filter(c=>!this.projects.some(l=>l.projectIdentifier===c.projectIdentifier));return o.length>0?(this.projects=[...this.projects,...o],console.log(`${o.length} new projects added`),this.offset=Math.max(this.offset-this.limit,0),o):(this.noMoreProjects=!0,[])}}catch(r){return console.error("Error fetching projects:",r),[]}finally{this.loading=!1}})}fetchProjectStats(e){let r=`${this.indexerService.getPrimaryIndexer(this.selectedNetwork)}api/query/Angor/projects/${e}/stats`;return console.log(`Fetching project stats from URL: ${r}`),this.http.get(r).pipe(Q(i=>(console.error(`Error fetching stats for project ${e}:`,i),A({}))))}fetchProjectDetails(e){let r=`${this.indexerService.getPrimaryIndexer(this.selectedNetwork)}api/query/Angor/projects/${e}`;return console.log(`Fetching project details from URL: ${r}`),this.http.get(r).pipe(Q(i=>(console.error(`Error fetching details for project ${e}:`,i),A({}))))}getProjects(){return this.projects}resetProjects(){this.projects=[],this.noMoreProjects=!1,this.offset=0,this.totalProjectsFetched=!1}};n.\u0275fac=function(t){return new(t||n)(b(xe),b($e))},n.\u0275prov=E({token:n,factory:n.\u0275fac,providedIn:"root"});let s=n;return s})();var L=Symbol("verified"),rt=s=>s instanceof Object;function st(s){if(!rt(s)||typeof s.kind!="number"||typeof s.content!="string"||typeof s.created_at!="number"||typeof s.pubkey!="string"||!s.pubkey.match(/^[a-f0-9]{64}$/)||!Array.isArray(s.tags))return!1;for(let n=0;n<s.tags.length;n++){let a=s.tags[n];if(!Array.isArray(a))return!1;for(let e=0;e<a.length;e++)if(typeof a[e]=="object")return!1}return!0}var Tt=new TextDecoder("utf-8"),it=new TextEncoder,nt=class{generateSecretKey(){return C.utils.randomPrivateKey()}getPublicKey(s){return k(C.getPublicKey(s))}finalizeEvent(s,n){let a=s;return a.pubkey=k(C.getPublicKey(n)),a.id=J(a),a.sig=k(C.sign(J(a),n)),a[L]=!0,a}verifyEvent(s){if(typeof s[L]=="boolean")return s[L];let n=J(s);if(n!==s.id)return s[L]=!1,!1;try{let a=C.verify(s.sig,n,s.pubkey);return s[L]=a,a}catch{return s[L]=!1,!1}}};function ot(s){if(!st(s))throw new Error("can't serialize event with wrong or missing properties");return JSON.stringify([0,s.pubkey,s.created_at,s.kind,s.tags,s.content])}function J(s){let n=Fe(it.encode(ot(s)));return k(n)}var U=new nt,At=U.generateSecretKey,Rt=U.getPublicKey,He=U.finalizeEvent,ze=U.verifyEvent;function at(s){return s instanceof Uint8Array||s!=null&&typeof s=="object"&&s.constructor.name==="Uint8Array"}function $(s,...n){if(!at(s))throw new Error("Uint8Array expected");if(n.length>0&&!n.includes(s.length))throw new Error(`Uint8Array expected of length ${n}, not of length=${s.length}`)}function Z(s,n=!0){if(s.destroyed)throw new Error("Hash instance has been destroyed");if(n&&s.finished)throw new Error("Hash#digest() has already been called")}function We(s,n){$(s);let a=n.outputLen;if(s.length<a)throw new Error(`digestInto() expects output buffer of length at least ${a}`)}var H=s=>new DataView(s.buffer,s.byteOffset,s.byteLength),v=(s,n)=>s<<32-n|s>>>n;var Nt=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;var ct=Array.from({length:256},(s,n)=>n.toString(16).padStart(2,"0"));function z(s){$(s);let n="";for(let a=0;a<s.length;a++)n+=ct[s[a]];return n}var w={_0:48,_9:57,_A:65,_F:70,_a:97,_f:102};function Ve(s){if(s>=w._0&&s<=w._9)return s-w._0;if(s>=w._A&&s<=w._F)return s-(w._A-10);if(s>=w._a&&s<=w._f)return s-(w._a-10)}function Qe(s){if(typeof s!="string")throw new Error("hex string expected, got "+typeof s);let n=s.length,a=n/2;if(n%2)throw new Error("padded hex string expected, got unpadded hex of length "+n);let e=new Uint8Array(a);for(let t=0,r=0;t<a;t++,r+=2){let i=Ve(s.charCodeAt(r)),o=Ve(s.charCodeAt(r+1));if(i===void 0||o===void 0){let c=s[r]+s[r+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+r)}e[t]=i*16+o}return e}function lt(s){if(typeof s!="string")throw new Error(`utf8ToBytes expected string, got ${typeof s}`);return new Uint8Array(new TextEncoder().encode(s))}function X(s){return typeof s=="string"&&(s=lt(s)),$(s),s}var O=class{clone(){return this._cloneInto()}},_t={}.toString;function qe(s){let n=e=>s().update(X(e)).digest(),a=s();return n.outputLen=a.outputLen,n.blockLen=a.blockLen,n.create=()=>s(),n}function ht(s,n,a,e){if(typeof s.setBigUint64=="function")return s.setBigUint64(n,a,e);let t=BigInt(32),r=BigInt(4294967295),i=Number(a>>t&r),o=Number(a&r),c=e?4:0,l=e?0:4;s.setUint32(n+c,i,e),s.setUint32(n+l,o,e)}var Ge=(s,n,a)=>s&n^~s&a,Je=(s,n,a)=>s&n^s&a^n&a,W=class extends O{constructor(n,a,e,t){super(),this.blockLen=n,this.outputLen=a,this.padOffset=e,this.isLE=t,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(n),this.view=H(this.buffer)}update(n){Z(this);let{view:a,buffer:e,blockLen:t}=this;n=X(n);let r=n.length;for(let i=0;i<r;){let o=Math.min(t-this.pos,r-i);if(o===t){let c=H(n);for(;t<=r-i;i+=t)this.process(c,i);continue}e.set(n.subarray(i,i+o),this.pos),this.pos+=o,i+=o,this.pos===t&&(this.process(a,0),this.pos=0)}return this.length+=n.length,this.roundClean(),this}digestInto(n){Z(this),We(n,this),this.finished=!0;let{buffer:a,view:e,blockLen:t,isLE:r}=this,{pos:i}=this;a[i++]=128,this.buffer.subarray(i).fill(0),this.padOffset>t-i&&(this.process(e,0),i=0);for(let h=i;h<t;h++)a[h]=0;ht(e,t-8,BigInt(this.length*8),r),this.process(e,0);let o=H(n),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");let l=c/4,d=this.get();if(l>d.length)throw new Error("_sha2: outputLen bigger than state");for(let h=0;h<l;h++)o.setUint32(4*h,d[h],r)}digest(){let{buffer:n,outputLen:a}=this;this.digestInto(n);let e=n.slice(0,a);return this.destroy(),e}_cloneInto(n){n||(n=new this.constructor),n.set(...this.get());let{blockLen:a,buffer:e,length:t,finished:r,destroyed:i,pos:o}=this;return n.length=t,n.pos=o,n.finished=r,n.destroyed=i,t%a&&n.buffer.set(e),n}};var dt=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),M=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),j=new Uint32Array(64),Y=class extends W{constructor(){super(64,32,8,!1),this.A=M[0]|0,this.B=M[1]|0,this.C=M[2]|0,this.D=M[3]|0,this.E=M[4]|0,this.F=M[5]|0,this.G=M[6]|0,this.H=M[7]|0}get(){let{A:n,B:a,C:e,D:t,E:r,F:i,G:o,H:c}=this;return[n,a,e,t,r,i,o,c]}set(n,a,e,t,r,i,o,c){this.A=n|0,this.B=a|0,this.C=e|0,this.D=t|0,this.E=r|0,this.F=i|0,this.G=o|0,this.H=c|0}process(n,a){for(let h=0;h<16;h++,a+=4)j[h]=n.getUint32(a,!1);for(let h=16;h<64;h++){let u=j[h-15],S=j[h-2],re=v(u,7)^v(u,18)^u>>>3,V=v(S,17)^v(S,19)^S>>>10;j[h]=V+j[h-7]+re+j[h-16]|0}let{A:e,B:t,C:r,D:i,E:o,F:c,G:l,H:d}=this;for(let h=0;h<64;h++){let u=v(o,6)^v(o,11)^v(o,25),S=d+u+Ge(o,c,l)+dt[h]+j[h]|0,V=(v(e,2)^v(e,13)^v(e,22))+Je(e,t,r)|0;d=l,l=c,c=o,o=i+S|0,i=r,r=t,t=e,e=S+V|0}e=e+this.A|0,t=t+this.B|0,r=r+this.C|0,i=i+this.D|0,o=o+this.E|0,c=c+this.F|0,l=l+this.G|0,d=d+this.H|0,this.set(e,t,r,i,o,c,l,d)}roundClean(){j.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}};var ee=qe(()=>new Y);var te=4;var Ze=(()=>{let n=class n{constructor(e,t,r,i){this.relayService=e,this.security=t,this.indexedDBService=r,this.metadataService=i,this.metadataSubject=new T,this.eventSubject=new T,this.notificationSubject=new T,this.messageSubject=new T,this.currentPage=0,this.messagesPerPage=50,this.allDecryptedMessages=[],this.isProcessing=!1,this.isDecrypting=!1,this.messageQueue=[],this.latestMessageTimestamps={},this.processedEventIds=new Set,this.chatList=[],this.chatListSubject=new se(this.chatList),this.nostrPublicKey="",this.nostrSignedEvent="",this.nostrEvent={created_at:Date.now(),kind:1,tags:[],content:"This is my nostr message",pubkey:""},this.eventUpdates$=this.eventSubject.asObservable()}signEventWithPassword(e,t,r,i,o,c){return f(this,null,function*(){let l=yield this.security.decryptData(t,r),d=Qe(l);if(!this.isValidHex(z(d)))throw console.error("Invalid secret key provided:",z(d)),new Error("Invalid secret key format");let h=this.createEvent(e,i,o,c),u=He(h,d);if(!this.isValidHex(u.id))throw console.error("Invalid signed event ID:",u.id),new Error("Invalid signed event format");return u})}signEventWithExtension(e,t,r,i){return f(this,null,function*(){let o=globalThis;if(!o.nostr||typeof o.nostr.signEvent!="function")throw new Error("Nostr extension not available or signEvent method is missing.");let c=this.createEvent(e,t,r,i);try{return yield o.nostr.signEvent(c)}catch(l){throw console.error("Error signing event with extension:",l),l}})}signEvent(e,t,r){return f(this,null,function*(){let{encryptedPrivateKey:i,password:o,useExtension:c,tags:l,pubkey:d}=r;if(c)return this.signEventWithExtension(e,t,l,d);if(i&&o)return this.signEventWithPassword(e,i,o,t,l,d);throw new Error("No valid signing method provided.")})}createEvent(e,t,r,i){return{kind:t,created_at:Math.floor(Date.now()/1e3),tags:r,content:e,pubkey:i,id:"",sig:""}}getEventId(e){return f(this,null,function*(){let t=JSON.stringify([0,e.pubkey,e.created_at,e.kind,e.tags,e.content]);return z(yield ee(t))})}serializeEvent(e){return JSON.stringify([0,e.pubkey,e.created_at,e.kind,e.tags,e.content])}getEventHash(e){let t=new TextEncoder,r=ee(t.encode(this.serializeEvent(e)));return this.bytesToHex(r)}verifyEvent(e){return ze(e)}decryptMessageWithExtension(e,t){return f(this,null,function*(){try{return yield globalThis.nostr.nip04.decrypt(t,e)}catch(r){throw console.error("Error decrypting message with extension:",r),new Error("Failed to decrypt message with Nostr extension.")}})}encryptMessageWithExtension(e,t){return f(this,null,function*(){return yield globalThis.nostr.nip04.encrypt(t,e)})}encryptMessage(e,t,r){return f(this,null,function*(){console.log(r);try{return yield G.encrypt(e,t,r)}catch(i){throw console.error("Error encrypting message:",i),i}})}decryptMessage(e,t,r){return f(this,null,function*(){try{return yield G.decrypt(e,t,r)}catch(i){throw console.error("Error decrypting message:",i),i}})}updateProfile(c,l,d){return f(this,arguments,function*(e,t,r,i=[],o=null){let h=JSON.stringify({name:e,about:t,picture:r}),u=o,S=this.createEvent(h,0,i,u);return this.publishEventToRelays(S)})}getFollowers(e){return f(this,null,function*(){yield this.relayService.ensureConnectedRelays();let t=this.relayService.getPool(),r=this.relayService.getConnectedRelays();if(r.length===0)throw new Error("No connected relays");let i=[{kinds:[3],"#p":[e]}],o=[];return new Promise(c=>{let l=t.subscribeMany(r,i,{onevent:d=>{o.push({nostrPubKey:d.pubkey}),this.eventSubject.next(d)},oneose(){l.close(),c(o)}})})})}getFollowing(e){return f(this,null,function*(){yield this.relayService.ensureConnectedRelays();let t=this.relayService.getPool(),r=this.relayService.getConnectedRelays();if(r.length===0)throw new Error("No connected relays");let i=[{kinds:[3],authors:[e]}],o=[];return new Promise(c=>{let l=t.subscribeMany(r,i,{onevent:d=>{d.tags.filter(u=>u[0]==="p").forEach(u=>{o.push({nostrPubKey:u[1]}),this.eventSubject.next(d)})},oneose(){l.close(),c(o)}})})})}getEventsByAuthor(r){return f(this,arguments,function*(e,t=[1]){yield this.relayService.ensureConnectedRelays();let i=this.relayService.getPool(),o=this.relayService.getConnectedRelays();if(o.length===0)throw new Error("No connected relays");let c=[{authors:[e],kinds:t}];return new Promise(l=>{let d=[],h=i.subscribeMany(o,c,{onevent:u=>{d.push(u),this.eventSubject.next(u)},oneose(){h.close(),l(d)}})})})}publishEventToRelays(e){return f(this,null,function*(){yield this.relayService.ensureConnectedRelays();let t=this.relayService.getPool(),r=this.relayService.getConnectedRelays();if(r.length===0)throw new Error("No connected relays");let i=r.map(o=>f(this,null,function*(){try{return yield t.publish([o],e),console.log(`Event published to relay: ${o}`),this.eventSubject.next(e),e}catch(c){throw console.error(`Failed to publish event to relay: ${o}`,c),c}}));try{return yield Promise.any(i),e}catch(o){throw console.error("Failed to publish event: AggregateError",o),this.handlePublishFailure(o),o}})}handlePublishFailure(e){e instanceof AggregateError?console.error("All relays failed to publish the event. Retrying..."):console.error("An unexpected error occurred:",e)}subscribeToEvents(e){this.relayService.ensureConnectedRelays().then(()=>{let t={kinds:[1],authors:[e],limit:20};this.relayService.subscribeToFilter(t),this.relayService.getEventStream().pipe(ne(1e3),ie(r=>this.processAndSortEvents(r))).subscribe(r=>{r.forEach(i=>this.eventSubject.next(i))})})}processAndSortEvents(e){let t=e.sort((r,i)=>i.created_at-r.created_at);return A(t)}subscribeToNotifications(e){this.relayService.ensureConnectedRelays().then(()=>{let t={kinds:[1,4],"#p":[e],limit:50};this.relayService.subscribeToFilter(t),this.relayService.getEventStream().subscribe(r=>{if(this.isNotificationEvent(r,e)){let i=r.created_at*1e3,c=new Date(i).toLocaleString();r.kind===4?r.content=`Sent a private message at ${c}.`:r.kind===1&&(r.content=`Mentioned you in an event at ${c}.`),this.notificationSubject.next(r)}})})}isNotificationEvent(e,t){return e.tags.some(r=>r[0]==="p"&&r[1]===t)}getNotificationStream(){return this.notificationSubject.asObservable()}getEventStream(){return this.relayService.getEventStream()}getNostrPublicKeyFromExtension(){return f(this,null,function*(){let t=yield globalThis.nostr.getPublicKey();this.nostrPublicKey=t,this.nostrEvent.pubkey=this.nostrPublicKey})}getNostrPublicRelaysFromExtension(){return f(this,null,function*(){let t=yield globalThis.nostr.getRelays();this.nostrRelays=t})}isValidHex(e){return/^[0-9a-fA-F]+$/.test(e)&&e.length%2===0}decryptPrivateKeyWithPassword(e,t){return f(this,null,function*(){try{return yield this.security.decryptData(e,t)}catch(r){throw console.error("Error decrypting private key with password:",r),new Error("Failed to decrypt private key with the provided password.")}})}bytesToHex(e){return Array.from(e,t=>t.toString(16).padStart(2,"0")).join("")}subscribeToKind4Messages(e,t,r,i){this.currentPage=0,this.allDecryptedMessages=[],this.processedEventIds.clear(),this.loadMessages(e,t,r,i,this.currentPage),this.subscribeToRealTimeMessages(e,t,r,i)}loadMessages(e,t,r,i,o){this.relayService.ensureConnectedRelays().then(()=>{let c=[{kinds:[4],authors:[e],"#p":[t],limit:this.messagesPerPage,until:this.getPaginationTime(o)},{kinds:[4],authors:[t],"#p":[e],limit:this.messagesPerPage,until:this.getPaginationTime(o)}];this.relayService.getPool().subscribeMany(this.relayService.getConnectedRelays(),c,{onevent:l=>{!this.processedEventIds.has(l.id)&&!this.messageQueue.some(d=>d.id===l.id)&&(this.messageQueue.push(l),this.processQueue(e,r,i,t))},oneose:()=>{console.log("Subscription closed")}})})}getPaginationTime(e){if(e===0)return Math.floor(Date.now()/1e3);let t=this.getOldestMessageTimestamp();return t||Math.floor(Date.now()/1e3)}loadMoreMessages(e,t,r,i){this.currentPage++,this.loadMessages(e,t,r,i,this.currentPage)}subscribeToRealTimeMessages(e,t,r,i){this.relayService.ensureConnectedRelays().then(()=>{let o=[{kinds:[4],authors:[e],"#p":[t]},{kinds:[4],authors:[t],"#p":[e]}];this.relayService.getPool().subscribeMany(this.relayService.getConnectedRelays(),o,{onevent:c=>{!this.processedEventIds.has(c.id)&&!this.messageQueue.some(l=>l.id===c.id)&&(this.messageQueue.push(c),this.processQueue(e,r,i,t))},oneose:()=>{console.log("Real-time subscription closed")}})})}processQueue(e,t,r,i){return f(this,null,function*(){if(this.isProcessing){console.log("Processing is already in progress, waiting for the current batch to finish...");return}this.isProcessing=!0;try{for(;this.messageQueue.length>0;){let o=this.messageQueue.shift();if(o&&!this.processedEventIds.has(o.id)){console.log(`Processing event with ID: ${o.id}`);try{let c=yield this.decryptReceivedMessage(o,t,r,i);if(c){let l=o.created_at*1e3,d={isSentByUser:o.pubkey===e,decryptedMessage:c,createdAt:l};this.allDecryptedMessages.push(d),this.allDecryptedMessages.sort((h,u)=>h.createdAt-u.createdAt),this.messageSubject.next(d),this.processedEventIds.add(o.id)}else console.warn(`Decrypted message is empty for event ID: ${o.id}`)}catch(c){console.error(`Failed to decrypt event with ID: ${o.id}`,c)}}else console.log(`Event with ID: ${o?.id} has already been processed or is invalid.`)}}catch(o){console.error("An error occurred while processing the message queue:",o)}finally{this.isProcessing=!1,console.log("Finished processing the message queue.")}this.messageQueue.length>0&&(console.log("Re-triggering processQueue as there are more messages in the queue..."),this.processQueue(e,t,r,i))})}decryptReceivedMessage(e,t,r,i){return f(this,null,function*(){return t?yield this.decryptMessageWithExtension(e.content,i):yield this.decryptMessage(r,i,e.content)})}getOldestMessageTimestamp(){return this.allDecryptedMessages.length===0?null:this.allDecryptedMessages.reduce((e,t)=>t.createdAt<e?t.createdAt:e,this.allDecryptedMessages[0].createdAt)}getMessageStream(){return this.messageSubject.asObservable()}subscribeToChatList(e,t,r){this.relayService.ensureConnectedRelays().then(()=>{let i=[{kinds:[te],authors:[e]},{kinds:[te],"#p":[e]}];this.relayService.getPool().subscribeMany(this.relayService.getConnectedRelays(),i,{onevent:o=>f(this,null,function*(){let c=o.pubkey===e?o.tags.find(d=>d[0]==="p")?.[1]||"":o.pubkey;if(!c)return;let l=this.latestMessageTimestamps[c]||0;o.created_at>l&&(this.latestMessageTimestamps[c]=o.created_at,this.messageQueue.push(o),this.processNextMessage(e,t,r))}),oneose:()=>{console.log("Subscription closed"),this.chatListSubject.next(this.chatList)}})})}processNextMessage(e,t,r){return f(this,null,function*(){if(this.isDecrypting||this.messageQueue.length===0)return;this.isDecrypting=!0;let i=this.messageQueue.shift();if(!i){this.isDecrypting=!1;return}let c=i.pubkey===e?i.tags.find(l=>l[0]==="p")?.[1]||"":i.pubkey;if(!c){this.isDecrypting=!1;return}try{let l=yield this.decryptReceivedMessage(i,t,r,c);if(l){let d=i.created_at*1e3;this.addOrUpdateChatList(c,l,d)}}catch(l){console.error("Failed to decrypt message:",l)}finally{this.isDecrypting=!1,this.processNextMessage(e,t,r)}})}addOrUpdateChatList(e,t,r){let i=this.chatList.find(o=>o.pubKey===e);i?i.lastMessageTime<r&&(i.lastMessage=t,i.lastMessageTime=r):(this.chatList.push({pubKey:e,lastMessage:t,lastMessageTime:r}),this.fetchMetadataForPubKey(e)),this.chatList.sort((o,c)=>c.lastMessageTime-o.lastMessageTime)}fetchMetadataForPubKey(e){this.metadataService.fetchMetadataWithCache(e).then(t=>{if(t){let r=this.chatList.find(i=>i.pubKey===e);r&&(r.metadata=t,this.chatListSubject.next(this.chatList))}}).catch(t=>{console.error(`Failed to fetch metadata for pubKey: ${e}`,t)})}getChatListStream(){return this.chatListSubject.asObservable()}};n.\u0275fac=function(t){return new(t||n)(b(Ke),b(De),b(ke),b(_))},n.\u0275prov=E({token:n,factory:n.\u0275fac,providedIn:"root"});let s=n;return s})();var Xe=(()=>{let n=class n{constructor(e){this.nostrService=e,this.projects=[],this.metadataCache=new Map}setProjects(e){return f(this,null,function*(){this.projects=e,this.updateMetadataInBackground()})}getProjects(){return this.projects}hasProjects(){return this.projects.length>0}updateProjectActivity(e){return f(this,null,function*(){let t=this.projects.findIndex(r=>r.nostrPubKey===e.nostrPubKey);t>-1?this.projects[t]=e:this.projects.push(e),this.projects.sort((r,i)=>i.lastActivity-r.lastActivity),yield this.updateMetadataForProject(e)})}updateMetadataInBackground(){for(let t=0;t<this.projects.length;t+=5)this.projects.slice(t,t+5).forEach(i=>this.updateMetadataForProject(i))}updateMetadataForProject(e){return f(this,null,function*(){if(this.metadataCache.has(e.nostrPubKey)){this.applyMetadata(e,this.metadataCache.get(e.nostrPubKey));return}})}applyMetadata(e,t){t&&typeof t=="object"?(e.displayName=t.name||e.displayName,e.picture=t.picture||e.picture):console.warn(`Metadata for project ${e.nostrPubKey} is invalid or null.`)}};n.\u0275fac=function(t){return new(t||n)(b(Ze))},n.\u0275prov=E({token:n,factory:n.\u0275fac,providedIn:"root"});let s=n;return s})();function gt(s,n){if(s&1&&(le(0),p(1,"angor-card",24)(2,"div",25),P(3,"img",26),g(),p(4,"div",27)(5,"div",28),P(6,"img",29),g()(),p(7,"div",30)(8,"div",31)(9,"div",32)(10,"div",33),x(11),g(),p(12,"div",34),x(13),g()(),p(14,"div",35)(15,"button",36),P(16,"mat-icon",37),g()()(),P(17,"hr",38),p(18,"div",31)(19,"div",39),x(20),g(),p(21,"div",40),P(22,"img",41),g()()()(),he()),s&2){let a=n.$implicit;m(3),y("src",a.banner||"images/pages/profile/cover.jpg",D),m(3),y("src",a.picture||"images/avatars/avatar-placeholder.png",D),m(5),I(" ",a.displayName||a.nostrPubKey," "),m(2),I(" ",a.about||"No description available"," "),m(3),y("svgIcon","heroicons_solid:user-plus"),m(4),I(" ",a.totalInvestmentsCount||0," investors "),m(2),y("src","images/avatars/avatar-placeholder.png",D)}}function mt(s,n){s&1&&(p(0,"div",42),x(1,"Loading Projects..."),g())}function yt(s,n){if(s&1&&(p(0,"div",43),x(1),g()),s&2){let a=fe();m(),I(" ",a.errorMessage," ")}}var Ye=(()=>{let n=class n{filterByQuery(e){throw new Error("Method not implemented.")}toggleCompleted(e){throw new Error("Method not implemented.")}constructor(e,t,r,i){this.projectService=e,this.router=t,this.stateService=r,this.metadataService=i,this.projects=[],this.errorMessage="",this.loading=!1,this.metadataLoadLimit=5}ngOnInit(){this.projects=this.stateService.getProjects(),this.projects.length===0?this.loadProjects():this.loading=!1}loadProjects(){this.loading||this.errorMessage==="No more projects found"||(this.loading=!0,this.projectService.fetchProjects().then(e=>f(this,null,function*(){e.length===0&&this.projects.length===0?this.errorMessage="No projects found":e.length===0?this.errorMessage="No more projects found":(this.projects=[...this.projects,...e],this.stateService.setProjects(this.projects)),this.loading=!1})).catch(e=>{console.error("Error fetching projects:",e),this.errorMessage="Error fetching projects. Please try again later.",this.loading=!1}))}loadMetadataForProject(e){return f(this,null,function*(){try{let t=yield this.metadataService.fetchMetadataWithCache(e.nostrPubKey);t?this.updateProjectMetadata(e,t):console.warn(`No metadata found for project ${e.nostrPubKey}`)}catch(t){console.error(`Error fetching metadata for project ${e.nostrPubKey}:`,t)}})}updateProjectMetadata(e,t){e.displayName=t.name,e.about=t.about,e.picture=t.picture}goToProjectDetails(e){this.router.navigate(["/projects",e.projectIdentifier])}ngOnDestroy(){}};n.\u0275fac=function(t){return new(t||n)(R(Oe),R(ve),R(Xe),R(_))},n.\u0275cmp=oe({type:n,selectors:[["explore"]],standalone:!0,features:[pe],decls:29,vars:8,consts:[["query",""],[1,"absolute","inset-0","flex","min-w-0","flex-col","overflow-y-auto"],[1,"dark","relative","flex-0","overflow-hidden","bg-gray-800","px-4","py-8","sm:p-16"],["viewBox","0 0 960 540","width","100%","height","100%","preserveAspectRatio","xMidYMax slice","xmlns","http://www.w3.org/2000/svg",1,"absolute","inset-0","pointer-events-none"],["fill","none","stroke","currentColor","stroke-width","100",1,"text-gray-700","opacity-25"],["r","234","cx","196","cy","23"],["r","234","cx","790","cy","491"],[1,"relative","z-10","flex","flex-col","items-center"],[1,"text-xl","font-semibold"],[1,"mt-1","text-center","text-4xl","font-extrabold","leading-tight","tracking-tight","sm:text-7xl"],[1,"text-secondary","mt-6","max-w-2xl","text-center","tracking-tight","sm:text-2xl"],[1,"flex","flex-auto","p-6","sm:p-10"],[1,"mx-auto","flex","w-full","max-w-xs","flex-auto","flex-col","sm:max-w-5xl"],[1,"flex","w-full","max-w-xs","flex-col","items-center","justify-between","sm:max-w-none","sm:flex-row"],[1,"mt-4","w-full","sm:mt-0","sm:w-72",3,"subscriptSizing"],["matPrefix","",1,"icon-size-5",3,"svgIcon"],["placeholder","Search ...","matInput","",3,"input"],[1,"mt-8","sm:ml-auto","sm:mt-0",3,"change","color"],[1,"grid","w-full","min-w-0","grid-cols-1","gap-6","sm:grid-cols-2","md:grid-cols-2","lg:grid-cols-3","mt-10"],[4,"ngFor","ngForOf"],[1,"flex","justify-center","mt-10"],["mat-raised-button","","color","primary",3,"click","disabled"],["class","loading-spinner",4,"ngIf"],["class","error-message",4,"ngIf"],[1,"filter-info","flex","w-full","flex-col"],[1,"flex","h-32"],["alt","Card cover image",1,"object-cover",3,"src"],[1,"flex","px-8"],[1,"bg-card","-mt-12","rounded-full","p-1"],["alt","Project logo",1,"h-24","w-24","rounded-full",3,"src"],[1,"flex","flex-col","px-8","pb-6","pt-4"],[1,"flex","items-center","justify-between"],[1,"mr-4"],[1,"text-2xl","font-semibold","leading-tight"],[1,"text-secondary","mt-1","leading-tight"],[1,"flex","h-10","w-10","items-center","justify-center","rounded-full","border"],["mat-icon-button",""],[1,"icon-size-5",3,"svgIcon"],[1,"my-6","w-full","border-t"],[1,"text-secondary","mr-3","text-md","font-medium"],[1,"flex","items-center"],["alt","Investor avatar",1,"text-card","ring-bg-card","m-0.5","-ml-3","h-6","w-6","rounded-full","ring-2",3,"src"],[1,"loading-spinner"],[1,"error-message"]],template:function(t,r){if(t&1){let i=de();p(0,"div",1)(1,"div",2),ae(),p(2,"svg",3)(3,"g",4),P(4,"circle",5)(5,"circle",6),g()(),ce(),p(6,"div",7)(7,"h2",8),x(8,"Explore Projects"),g(),p(9,"div",9),x(10," What\u2019s your next investment? "),g(),p(11,"div",10),x(12," Check out our projects and find your next investment opportunity. "),g()()(),p(13,"div",11)(14,"div",12)(15,"div",13)(16,"mat-form-field",14),P(17,"mat-icon",15),p(18,"input",16,0),N("input",function(){F(i);let c=ue(19);return K(r.filterByQuery(c.value))}),g()(),p(20,"mat-slide-toggle",17),N("change",function(c){return F(i),K(r.toggleCompleted(c))}),x(21," Hide completed "),g()(),p(22,"div",18),q(23,gt,23,7,"ng-container",19),g(),p(24,"div",20)(25,"button",21),N("click",function(){return F(i),K(r.loadProjects())}),x(26),g()(),q(27,mt,2,0,"div",22)(28,yt,2,1,"div",23),g()()()}t&2&&(m(16),y("subscriptSizing","dynamic"),m(),y("svgIcon","heroicons_solid:magnifying-glass"),m(3),y("color","primary"),m(3),y("ngForOf",r.projects),m(2),y("disabled",r.loading),m(),I(" ",r.loading?"Loading...":"Load More Projects"," "),m(),y("ngIf",r.loading),m(),y("ngIf",!r.loading&&r.errorMessage))},dependencies:[je,Pe,Me,Ce,Ie,Ue,Ee,Se,we,Ne,be,Re,Ae,Be,_e,Le,Te,ye,ge,me],encapsulation:2});let s=n;return s})();var kr=[{path:"",component:Ye}];export{kr as default};
