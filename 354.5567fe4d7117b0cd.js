"use strict";(self.webpackChunkangor=self.webpackChunkangor||[]).push([[354],{1772:(F,O,h)=>{h.d(O,{x:()=>y});var d=h(467),m=h(5766);class M{constructor(S,t,e,s,n,l,o=[]){this.username="",this.picture="/images/avatars/avatar-placeholder.png",this.replyCount=0,this.likeCount=0,this.zapCount=0,this.repostCount=0,this.likedByMe=!1,this.replies=[],this.likers=[],this.reposters=[],this.zappers=[],this.relatedEventIds=[],this.rootEventId="",this.replyToEventId="",this.mentions=[],this.hashtags=[],this.repostedByMe=!1,this.tags=[],this.isAReply=!1,this.kind=t,this.pubkey=e,this.content=s,this.noteId=n,this.createdAt=l,this.date=new Date(1e3*this.createdAt),this.fromNow=this.calculateTimeFromNow(this.date),this.tags=o,this.id=S}calculateTimeFromNow(S){const e=Math.floor(((new Date).getTime()-S.getTime())/1e3);return e<60?`${e} seconds ago`:e<3600?`${Math.floor(e/60)} minutes ago`:e<86400?`${Math.floor(e/3600)} hours ago`:e<2592e3?`${Math.floor(e/86400)} days ago`:e<31536e3?`${Math.floor(e/2592e3)} months ago`:`${Math.floor(e/31536e3)} years ago`}}var R=h(719),C=h(4412),k=h(3236),P=h(9974),c=h(4360),p=h(8750),a=h(1584);var u=h(4438),f=h(6231),b=h(6324),j=h(7343);let y=(()=>{class w{constructor(t,e,s){this.relayService=t,this.signerService=e,this.queueService=s,this.eventsSubject=new C.t([]),this.isLoading=new C.t(!1),this.lastLoadedEventTime=null,this.pageSize=10,this.noMoreEvents=new C.t(!1),this.seenEventIds=new Set,this.likesMap=new Map,this.repliesMap=new Map,this.zapsMap=new Map,this.repostsMap=new Map,this.hasLikedMap=new Map,this.hasRepostedMap=new Map,this.jobQueue=[],this.isProcessingQueue=!1,this.myLikedNoteIds=[]}subscribeToEvents(t){var e=this;return(0,d.A)(function*(){yield e.relayService.ensureConnectedRelays();const s=e.relayService.getConnectedRelays().slice(0,3);if(!s||0===s.length)return void console.error("No connected relays available.");const n=[{kinds:[1],authors:t,limit:e.pageSize},{"#p":t,limit:1}];e.relayService.getPool().subscribeMany(s,n,{onevent:o=>{e.isReply(o)||e.handleNewOrUpdatedEvent(o);const r=e.getParentEventId(o);switch(r&&e.enqueueJob(r),o.kind){case 7:case 9735:case 6:e.enqueueJob(r)}},oneose:()=>{}})})()}getParentEventId(t){const e=t.tags.find(s=>"e"===s[0]);return e?e[1]:null}handleNewOrUpdatedEvent(t){var e=this;return(0,d.A)(function*(){switch(t.kind){case 1:if(!e.seenEventIds.has(t.id)){e.seenEventIds.add(t.id);const s=yield e.createNewEvent(t);e.eventsSubject.next([s]),e.updateEventInSubject(t.id)}break;case 7:e.handleLikeEvent(t);break;case 9735:e.handleZapEvent(t);break;case 6:e.handleRepostEvent(t);break;case 4:e.handleReplyEvent(t)}})()}handleLikeEvent(t){const e=t.tags.find(s=>"e"===s[0])?.[1];if(e){const n=this.eventsSubject.getValue().find(l=>l.id===e);n&&(n.likeCount+=1,n.likers=[...n.likers||[],t.pubkey],this.eventsSubject.next([n]))}}handleZapEvent(t){const e=t.tags.find(s=>"e"===s[0])?.[1];if(e){const n=this.eventsSubject.getValue().find(l=>l.id===e);n&&(n.zapCount+=1,n.zappers=[...n.zappers||[],t.pubkey],this.eventsSubject.next([n]))}}handleRepostEvent(t){const e=t.tags.find(s=>"e"===s[0])?.[1];if(e){const n=this.eventsSubject.getValue().find(l=>l.id===e);n&&(n.repostCount+=1,n.reposters=[...n.reposters||[],t.pubkey],this.eventsSubject.next([n]))}}handleReplyEvent(t){var e=this;return(0,d.A)(function*(){const s=t.tags.find(n=>"e"===n[0])?.[1];if(s){const n=yield e.createNewEvent(t),o=e.eventsSubject.getValue().find(r=>r.id===s);o&&(o.replyCount+=1,o.replies=[...o.replies||[],n],e.eventsSubject.next([o]))}})()}isReply(t){return t.tags.filter(s=>"e"===s[0]||"p"===s[0]).length>0}getMyLikes(){var t=this;return(0,d.A)(function*(){const e={kinds:[7],authors:[t.signerService.getPublicKey()]};try{return(yield t.fetchFilteredEvents(e)).forEach(n=>{const l=n.tags.find(o=>"e"===o[0]);l&&t.myLikedNoteIds.push(l[1])}),t.myLikedNoteIds}catch(s){return console.error("Failed to get user likes:",s),[]}})()}loadMoreEvents(t){var e=this;return(0,d.A)(function*(){if(e.isLoading.value||e.noMoreEvents.value)return;e.isLoading.next(!0);const s={authors:t,kinds:[1],until:e.lastLoadedEventTime||Math.floor(Date.now()/1e3),limit:e.pageSize};try{const n=yield e.fetchFilteredEvents(s);if(n.length<e.pageSize&&e.noMoreEvents.next(!0),n.length>0){e.lastLoadedEventTime=n[n.length-1].created_at;const l=n.filter(r=>!e.seenEventIds.has(r.id)&&!e.isReply(r));l.forEach(r=>e.seenEventIds.add(r.id));const o=yield Promise.all(l.map(r=>e.createNewEvent(r)));e.eventsSubject.next([...e.eventsSubject.getValue(),...o].sort((r,E)=>E.createdAt-r.createdAt))}else e.noMoreEvents.next(!0)}catch(n){console.error("Error loading more events:",n)}finally{e.isLoading.next(!1)}})()}fetchFilteredEvents(t){var e=this;return(0,d.A)(function*(){return new Promise((s,n)=>{const l=new Map,o=[];e.queueService.addRequestToQueue([t]).subscribe({next:r=>{l.has(r.id)||(l.set(r.id,r),o.push(r))},error:r=>{console.error("Error fetching events:",r),n(r)},complete:()=>{console.log("All events fetched and completed"),s(o)}})})})()}createNewEvent(t){var e=this;return(0,d.A)(function*(){const s=new M(t.id,t.kind,t.pubkey,t.content,t.id,t.created_at,t.tags);return e.enqueueJob(t.id),yield e.processJobQueue(),s.likedByMe=e.myLikedNoteIds.includes(t.id),s})()}enqueueJob(t){this.jobQueue.some(e=>e.eventId===t)||(this.jobQueue.push({eventId:t}),this.isProcessingQueue||this.processJobQueue())}processJobQueue(){var t=this;return(0,d.A)(function*(){if(t.isProcessingQueue)return;t.isProcessingQueue=!0;const e=[];for(;t.jobQueue.length>0||e.length>0;){for(;t.jobQueue.length>0&&e.length<10;){const s=t.jobQueue.shift();if(!s)break;yield t.delay(1e3);const n=t.processJobWithQueueService(s);e.push(n),n.then(()=>{e.splice(e.indexOf(n),1)}).catch(l=>{console.error("Error processing job:",l),e.splice(e.indexOf(n),1)})}yield Promise.race(e)}t.isProcessingQueue=!1})()}processJobWithQueueService(t){var e=this;return(0,d.A)(function*(){try{const s=yield e.fetchMultiFilterEvents(t.eventId);e.repliesMap.set(t.eventId,s.replies),e.likesMap.set(t.eventId,s.likers),e.zapsMap.set(t.eventId,s.zappers),e.repostsMap.set(t.eventId,s.reposters),e.updateEventInSubject(t.eventId)}catch(s){throw console.error("Error processing job with QueueService:",s),s}})()}delay(t){return new Promise(e=>setTimeout(e,t))}updateEventInSubject(t){const s=this.eventsSubject.getValue().map(n=>(n.id===t&&(n.replyCount=this.getRepliesCount(t),n.replies=this.repliesMap.get(t)||[],n.likeCount=this.getLikesCount(t),n.likers=this.likesMap.get(t)||[],n.zapCount=this.getZapsCount(t),n.zappers=this.zapsMap.get(t)||[],n.repostCount=this.getRepostsCount(t),n.reposters=this.repostsMap.get(t)||[]),n));this.eventsSubject.next(s)}fetchMultiFilterEvents(t){var e=this;return(0,d.A)(function*(){const s=[{"#e":[t],kinds:[1]},{"#e":[t],kinds:[7]},{"#e":[t],kinds:[9735]},{"#e":[t],kinds:[6]}],n=new Map,l=[],o=[],r=[],E=[],T=e.queueService.addRequestToQueue(s);return new Promise((x,A)=>{var L;T.subscribe({next:(L=(0,d.A)(function*(v){if(n.has(v.id)||n.set(v.id,v),1===v.kind){const I=yield e.createNewEvent(v);l.push(I)}else 7===v.kind?o.push(v.pubkey):9735===v.kind?r.push(v.pubkey):6===v.kind&&E.push(v.pubkey)}),function(I){return L.apply(this,arguments)}),error:L=>{console.error("Error fetching events:",L),A(L)},complete:()=>{x({replies:l,likers:o,zappers:r,reposters:E})}})})})()}getRepliesCount(t){return(this.repliesMap.get(t)||[]).length}getLikesCount(t){return(this.likesMap.get(t)||[]).length}getZapsCount(t){return(this.zapsMap.get(t)||[]).length}getRepostsCount(t){return(this.repostsMap.get(t)||[]).length}hasUserLiked(t){return this.hasLikedMap.get(t)||!1}hasUserReposted(t){return this.hasRepostedMap.get(t)||!1}getEventStream(){return this.eventsSubject.asObservable().pipe(function g(w,S=k.E,t){const e=(0,a.O)(w,S);return function i(w,S){return(0,P.N)((t,e)=>{const{leading:s=!0,trailing:n=!1}=S??{};let l=!1,o=null,r=null,E=!1;const T=()=>{r?.unsubscribe(),r=null,n&&(L(),E&&e.complete())},x=()=>{r=null,E&&e.complete()},A=v=>r=(0,p.Tg)(w(v)).subscribe((0,c._)(e,T,x)),L=()=>{if(l){l=!1;const v=o;o=null,e.next(v),!E&&A(v)}};t.subscribe((0,c._)(e,v=>{l=!0,o=v,(!r||r.closed)&&(s?L():A(v))},()=>{E=!0,(!(n&&l&&r)||r.closed)&&e.complete()}))})}(()=>e,t)}(1e3))}hasMoreEvents(){return this.noMoreEvents.asObservable()}sendTextEvent(t){var e=this;return(0,d.A)(function*(){if(t)try{const n=e.signerService.getUnsignedEvent(1,[],t);let l;if(e.signerService.isUsingSecretKey()){const o=yield e.signerService.getDecryptedSecretKey(),r=(0,m.aT)(o);l=(0,R.pC)(n,r)}else l=yield e.signerService.signEventWithExtension(n);yield e.relayService.publishEventToWriteRelays(l)}catch(s){console.error("Failed to send text event:",s)}})()}sendLikeEvent(t){var e=this;return(0,d.A)(function*(){if(t)try{const l=e.signerService.getUnsignedEvent(7,[["e",t.id],["p",t.pubkey]],"+");let o;if(e.signerService.isUsingSecretKey()){const r=yield e.signerService.getDecryptedSecretKey(),E=(0,m.aT)(r);o=(0,R.pC)(l,E)}else o=yield e.signerService.signEventWithExtension(l);yield e.relayService.publishEventToWriteRelays(o),e.likesMap.set(t.id,[...e.likesMap.get(t.id)||[],e.signerService.getPublicKey()]),e.hasLikedMap.set(t.id,!0)}catch(s){console.error("Failed to send like event:",s)}})()}sendZapEvent(t,e){var s=this;return(0,d.A)(function*(){if(t&&!(e<=0))try{const n=[["e",t.id],["p",t.pubkey],["amount",e.toString()]],o=s.signerService.getUnsignedEvent(9735,n,`Zapped with ${e} sats`);let r;if(s.signerService.isUsingSecretKey()){const E=yield s.signerService.getDecryptedSecretKey(),T=(0,m.aT)(E);r=(0,R.pC)(o,T)}else r=yield s.signerService.signEventWithExtension(o);yield s.relayService.publishEventToWriteRelays(r)}catch(n){console.error("Failed to send zap event:",n)}})()}sendReplyEvent(t,e){var s=this;return(0,d.A)(function*(){if(t)try{const l=s.signerService.getUnsignedEvent(1,[["e",t.id],["p",t.pubkey]],e);let o;if(s.signerService.isUsingSecretKey()){const r=yield s.signerService.getDecryptedSecretKey(),E=(0,m.aT)(r);o=(0,R.pC)(l,E)}else o=yield s.signerService.signEventWithExtension(l);yield s.relayService.publishEventToWriteRelays(o)}catch(n){console.error("Failed to send reply event:",n)}})()}clearEvents(){this.eventsSubject.next([]),this.seenEventIds.clear(),this.lastLoadedEventTime=null,this.noMoreEvents.next(!1)}static{this.\u0275fac=function(e){return new(e||w)(u.KVO(f.b),u.KVO(b.A),u.KVO(j.F))}}static{this.\u0275prov=u.jDH({token:w,factory:w.\u0275fac,providedIn:"root"})}}return w})()},7343:(F,O,h)=>{h.d(O,{F:()=>C});var d=h(467),m=h(1413),M=h(4438),R=h(6231);let C=(()=>{class k{constructor(c){this.relayService=c,this.requestQueue=[],this.isProcessingQueue=!1,this.maxConcurrentRequests=2,this.currentRequestCount=0}addRequestToQueue(c){const p=new m.B;return this.requestQueue.push({filters:c,subject:p}),this.processQueue(),p.asObservable()}processQueue(){var c=this;return(0,d.A)(function*(){if(!c.isProcessingQueue){for(c.isProcessingQueue=!0;c.requestQueue.length>0&&c.currentRequestCount<c.maxConcurrentRequests;){const p=c.requestQueue.shift();if(!p)break;try{c.currentRequestCount++,yield c.handleRequest(p)}catch(i){p.subject.error(i)}finally{c.currentRequestCount--}}c.isProcessingQueue=!1,c.requestQueue.length>0&&c.processQueue()}})()}handleRequest(c){var p=this;return(0,d.A)(function*(){try{yield p.relayService.ensureConnectedRelays();const i=p.relayService.getConnectedRelays();if(0===i.length)throw new Error("No connected relays available");yield p.fetchEvents(i,c.filters,c.subject)}catch(i){c.subject.error(i)}})()}fetchEvents(c,p,i){var a=this;return(0,d.A)(function*(){const u=a.relayService.getPool().subscribeMany(c,p,{onevent:f=>{i.next(f)},oneose:()=>{u.close(),i.complete()}});setTimeout(()=>{u.close||(u.close(),i.complete())},5e3)})()}static{this.\u0275fac=function(p){return new(p||k)(M.KVO(R.b))}}static{this.\u0275prov=M.jDH({token:k,factory:k.\u0275fac,providedIn:"root"})}}return k})()},5713:(F,O,h)=>{h.d(O,{l:()=>P});var d=h(467),m=h(1413),M=h(4438),R=h(6231),C=h(6324),k=h(7343);let P=(()=>{class c{constructor(i,a,g){this.relayService=i,this.signerService=a,this.queueService=g,this.followersSubject=new m.B,this.followingSubject=new m.B}getFollowersObservable(){return this.followersSubject.asObservable()}getFollowingObservable(){return this.followingSubject.asObservable()}getFollowers(i){var a=this;return(0,d.A)(function*(){const g=[{kinds:[3],"#p":[i]}],u=[];return new Promise((f,b)=>{a.queueService.addRequestToQueue(g).subscribe({next:y=>{u.push(y),a.followersSubject.next(y)},error:y=>{console.error("Error fetching followers:",y),b(y)},complete:()=>{f(u)}})})})()}getFollowing(i){var a=this;return(0,d.A)(function*(){const g=[{kinds:[3],authors:[i]}],u=[];return new Promise((f,b)=>{a.queueService.addRequestToQueue(g).subscribe({next:y=>{y.tags.filter(S=>"p"===S[0]).forEach(S=>{u.push(S[1]),a.followingSubject.next(y)})},error:y=>{console.error("Error fetching following:",y),b(y)},complete:()=>{f(u)}})})})()}follow(i){var a=this;return(0,d.A)(function*(){const g=a.getFollowingList();if(g.includes(i))return void console.log(`Already following ${i}`);const u=[...g,i];a.setFollowingList(u);const f=a.signerService.getUnsignedEvent(3,u.map(b=>["p",b]),"");yield a.publishSignedEvent(f),console.log(`Now following ${i}`)})()}unfollow(i){var a=this;return(0,d.A)(function*(){const g=a.getFollowingList();if(!g.includes(i))return void console.log(`Not following ${i}`);const u=g.filter(b=>b!==i);a.setFollowingList(u);const f=a.signerService.getUnsignedEvent(3,u.map(b=>["p",b]),"");yield a.publishSignedEvent(f),console.log(`Unfollowed ${i}`)})()}publishSignedEvent(i){var a=this;return(0,d.A)(function*(){let u;if(yield a.signerService.isUsingExtension())u=yield a.signerService.signEventWithExtension(i);else{const f=yield a.signerService.getDecryptedSecretKey();if(!f)throw new Error("Secret key is missing. Unable to sign event.");u=a.signerService.getSignedEvent(i,f)}a.relayService.publishEventToWriteRelays(u)})()}getFollowingListAsTags(){const i=this.getFollowingList(),a=[],g=this.relayService.getConnectedRelays();return i.forEach(u=>{g.forEach(f=>{a.push(["p",u,f,localStorage.getItem(`${u}`)||""])})}),a}setFollowingListFromTags(i){const a=[];i.forEach(g=>{a.push(g[1])}),this.setFollowingList(a)}setFollowingList(i){const g=Array.from(new Set(i)).filter(u=>u).join(",");localStorage.setItem("following",g)}getFollowingList(){const i=localStorage.getItem("following");return null===i||""===i?[]:i.split(",").filter(g=>/[a-f0-9]{64}/.test(g))}static{this.\u0275fac=function(a){return new(a||c)(M.KVO(R.b),M.KVO(C.A),M.KVO(k.F))}}static{this.\u0275prov=M.jDH({token:c,factory:c.\u0275fac,providedIn:"root"})}}return c})()}}]);